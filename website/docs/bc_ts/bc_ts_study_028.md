# ç¬¬28ç«  ACLè¨­è¨ˆï¼šä½•ã‚’ã©ã†ç¿»è¨³ã™ã‚‹ï¼ŸğŸŒâ¡ï¸ğŸ ğŸ›¡ï¸

![ã‚¤ãƒ¡ãƒ¼ã‚¸](./picture/bc_ts_study_028_acl_solution.png)

## 0. ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

ACLï¼ˆAnti-Corruption Layerï¼‰ã‚’ **ã€Œå¤‰æ›ã®ç½®ãå ´ã€**ã¨ã—ã¦è¨­è¨ˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ãŒç›®æ¨™ã ã‚ˆğŸ˜ŠğŸ§¼

ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ã¯3ã¤ğŸ‘‡

* å¤–éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆDTOï¼‰ã‚’ **å†…å´ã®ãƒ¢ãƒ‡ãƒ«ã«â€œç¿»è¨³â€**ã§ãã‚‹ğŸ—£ï¸â¡ï¸ğŸ“¦
* â€œç¿»è¨³ãƒ«ãƒ¼ãƒ«â€ã‚’ **æ–‡ç« ã§æ®‹ã—ã¦**ã€è¿·å­ã«ãªã‚‰ãªã„ğŸ§¾ğŸ§­
* ACLãŒå£Šã‚Œãªã„ã‚ˆã†ã« **ãƒ†ã‚¹ãƒˆã§å®ˆã‚‹**ğŸ§ªğŸ›¡ï¸

æˆæœç‰©ã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ

* âœ… å·®åˆ†ãƒªã‚¹ãƒˆï¼ˆä½•ãŒé•ã†ï¼Ÿï¼‰
* âœ… å¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ï¼ˆã©ã†å¤‰ãˆã‚‹ï¼Ÿï¼‰
* âœ… å¤‰æ›ã‚³ãƒ¼ãƒ‰ï¼ˆDTOâ†’å†…éƒ¨ãƒ¢ãƒ‡ãƒ« / å†…éƒ¨â†’DTOï¼‰
* âœ… å¤‰æ›ãƒ†ã‚¹ãƒˆï¼ˆå›ºå®šã—ãŸã„ãƒ«ãƒ¼ãƒ«ãŒè½ã¡ãªã„ï¼‰

---

## 1. ACLã¯ã€Œç¿»è¨³ã®ç„é–¢ã€ğŸšªğŸ§¼

ACLã¯ã²ã¨ã“ã¨ã§è¨€ã†ã¨ã€**å¤–éƒ¨ã®ä¸–ç•Œã®ã‚¯ã‚»ãŒã€å†…å´ï¼ˆè‡ªåˆ†ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã«å…¥ã‚Šè¾¼ã‚€ã®ã‚’é˜²ãâ€œç¿»è¨³ã‚¾ãƒ¼ãƒ³â€**ã ã‚ˆğŸ§±âœ¨
å¤–éƒ¨ã®ãƒ¢ãƒ‡ãƒ«ã‚’ãã®ã¾ã¾ä¸­ã«æŒã¡è¾¼ã‚€ã¨ã€æ°—ã¥ã‹ãªã„ã†ã¡ã« **è¨€è‘‰ãƒ»å˜ä½ãƒ»çŠ¶æ…‹ãƒ»ã‚¨ãƒ©ãƒ¼**ã¾ã§å…¨éƒ¨å¼•ããšã‚‰ã‚Œã¦ã€å†…å´ãŒæ±šã‚Œã¦ã„ãğŸ˜‡â¡ï¸ğŸ˜±

ã ã‹ã‚‰ACLã¯ã€

* å¤–ã®è¨€è‘‰ â†’ **å†…ã®è¨€è‘‰**ã«å¤‰ãˆã‚‹ğŸ—£ï¸â¡ï¸ğŸ 
* å¤–ã®éƒ½åˆ â†’ **å†…ã®ãƒ«ãƒ¼ãƒ«**ã«åˆã‚ã›ã‚‹ğŸ“â¡ï¸ğŸ“
* å¤–ã®å¤±æ•—*   **(ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨€è‘‰)** ğŸ ï¼šä¾¡æ ¼ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€å•†å“ID

![ã‚¤ãƒ¡ãƒ¼ã‚¸](./picture/bc_ts_study_028_acl_translator_flow.png)

ã“ã‚Œã‚’å¤‰æ›ã™ã‚‹æµã‚Œã‚’è¦‹ã¦ã„ã“ã†ğŸ‘‡
ï¼ˆã€Œæ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’å®ˆã‚‹ãŸã‚ã«ç¿»è¨³å±¤ã‚’ä½œã‚‹ã€ãŒACLã®ä¸­å¿ƒï¼‰([microservices.io][1])
ã¾ãŸã€ACLã¯ Eric Evans ã®DDDæœ¬ã§ç´¹ä»‹ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è§¦ã‚Œã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‚ˆğŸ“š([martinfowler.com][2])

---

## 2. ã¾ãšã¯ã€Œå·®åˆ†ã€ã‚’æ£šå¸ã—ã—ã‚ˆã†ğŸ“‹ğŸ‘€

```mermaid
mindmap
  root((ç¿»è¨³ã™ã¹ãå·®åˆ†))
    å‘½åã®ã‚ºãƒ¬
      snake_case vs camelCase
    å‹ã®é•ã„
      string vs number
      nullã®æ‰±ã„
    å˜ä½ã®ä¸ä¸€è‡´
      ã‚»ãƒ³ãƒˆ vs å††
      g vs kg
    çŠ¶æ…‹ã®å®šç¾©
      ç‹¬è‡ªã®Status
    æ¬ æãƒ»ä»»æ„
      ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    å¤±æ•—ã®è¨€è‘‰
      ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å¤‰æ›
```

ACLè¨­è¨ˆã¯ã€ã„ããªã‚Šã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãªã„ã§OKğŸ™†â€â™€ï¸
æœ€åˆã«ã‚„ã‚‹ã®ã¯ **å·®åˆ†ã®æ£šå¸ã—**ï¼ˆå¤–ã¨å†…ã€ã©ã“ãŒã‚ºãƒ¬ã¦ã‚‹ï¼Ÿï¼‰ã ã‚ˆğŸ§ âœ¨

### 2-1. åå‰ã®å·®åˆ†ï¼ˆå‘½åï¼‰ğŸ·ï¸ğŸŒ€

* `shipment_id` â†” `shipmentId`
* `user_type` â†” `role`
* â€œuserâ€ãŒå¤–ã§ã¯ã€Œä¼šå“¡ã€ã ã‘ã©å†…ã§ã¯ã€Œè³¼å…¥è€…/å‡ºå“è€…ã€ã‚‚å«ã‚€â€¦ã¿ãŸã„ãªã‚ºãƒ¬ğŸ« 

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**å†…å´ã¯å†…å´ã®è¨€è‘‰ã‚’å„ªå…ˆ**ï¼ˆå¤–ã«åˆã‚ã›ãªã„ï¼‰ğŸ ğŸ›¡ï¸

### 2-2. å‹ã®å·®åˆ†ï¼ˆè¡¨ç¾ï¼‰ğŸ”¢ğŸ§©

* å¤–ï¼šæ•°å€¤ãŒæ–‡å­—åˆ— `"1200"` ã§æ¥ã‚‹
* å¤–ï¼š`null` ãŒæ™®é€šã«æ··ã–ã‚‹
* å¤–ï¼šé…åˆ—ãŒç©ºã‹`null`ã‹æœªå®šç¾©ã‹ãŒãƒãƒ©ãƒãƒ©ğŸ˜µ

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**å†…å´ã¯ã€Œæ„å‘³ãŒæ˜ç¢ºãªå‹ã€ã«å¯„ã›ã‚‹**ï¼ˆ`undefined`/`null`ã®æ‰±ã„ã‚‚æ±ºã‚ã‚‹ï¼‰âœ¨

### 2-3. å˜ä½ã®å·®åˆ†ï¼ˆé€šè²¨ãƒ»é‡é‡ãƒ»æ™‚é–“ï¼‰ğŸ’´âš–ï¸ğŸ•°ï¸

* å¤–ï¼š`fee_cents`ï¼ˆã‚»ãƒ³ãƒˆï¼‰
* å†…ï¼š`Money { amount, currency }`ï¼ˆé€šè²¨ã¨é‡‘é¡ï¼‰
* å¤–ï¼š`weight_grams`
* å†…ï¼š`weightKg`ï¼ˆkgã§çµ±ä¸€ï¼‰

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**å†…å´ã§å˜ä½ã‚’çµ±ä¸€**ï¼ˆå¤–ã®å˜ä½ã¯å…¥å£ã§å¤‰æ›ï¼‰ğŸ”

### 2-4. çŠ¶æ…‹ã®å·®åˆ†ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ğŸš¦ğŸ§¨

* å¤–ï¼š`IN_TRANSIT / DELIVERED / CANCELLED`
* å†…ï¼š`ShippingStatus.InDelivery / Delivered / Cancelled`ï¼ˆåå‰ã‚‚ç²’åº¦ã‚‚é•ã†ã“ã¨ãŒã‚ã‚‹ï¼‰

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**å†…å´ã®çŠ¶æ…‹é·ç§»ãŒæ­£**ï¼ˆå¤–ã®çŠ¶æ…‹ã¯â€œå¯¾å¿œè¡¨â€ã§å¸åï¼‰ğŸ“Œ

```mermaid
flowchart LR
    E["å¤–éƒ¨: IN_TRANSIT"] --> M[å¯¾å¿œè¡¨/Map]
    E2["å¤–éƒ¨: DELIVERED"] --> M
    E3["å¤–éƒ¨: æœªçŸ¥ã®å€¤ (?)"] --> M
    
    M --> I["å†…éƒ¨: InDelivery"]
    M --> I2["å†…éƒ¨: Delivered"]
    M --> Error["âŒ Error (æ°—ã¥ã‘ã‚‹!)"]
    
    style Error fill:#FFD6D6,stroke:#FF0000
```

### 2-5. æ¬ æã®å·®åˆ†ï¼ˆå¿…é ˆ/ä»»æ„ï¼‰ğŸ•³ï¸ğŸ§·

* å¤–ï¼šãŸã¾ã« `address` ãŒãªã„
* å†…ï¼šä½æ‰€ã¯å¿…é ˆï¼ˆé…é€ã§ããªã„ï¼‰

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**æ¬ æã¯ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€orã€Œã‚¨ãƒ©ãƒ¼ã€orã€Œä¿ç•™ã€**ã®ã©ã‚Œã«ã™ã‚‹ã‹æ±ºã‚ã‚‹âœ…

### 2-6. ã‚¨ãƒ©ãƒ¼ã®å·®åˆ†ï¼ˆå¤±æ•—ã®ç¨®é¡ï¼‰ğŸš¨ğŸ§¯

* å¤–ï¼šHTTP 429ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰
* å¤–ï¼š409ï¼ˆç«¶åˆï¼‰
* å¤–ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
* å†…ï¼šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒæ‰±ã†ã®ã¯ã€Œå†è©¦è¡Œã—ã¦ã„ã„ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒæ‚ªã„ã€ã€Œä¸€æ™‚çš„éšœå®³ã€ãªã©

ğŸ‘‰ ãƒ«ãƒ¼ãƒ«ï¼š**å¤–ã®ã‚¨ãƒ©ãƒ¼ã‚’â€œå†…ã®åˆ†é¡â€ã«ç¿»è¨³**ã™ã‚‹ğŸ§¸

---

## 3. ã€Œå†…å´ã®æ­£ã—ã„å½¢ã€ã‚’å…ˆã«æ±ºã‚ã‚‹ğŸ âœ¨

ACLã§å¤§äº‹ãªã®ã¯ã€**å†…å´ã‚’â€œå¤–ã«å¼•ããšã‚‰ã‚Œãªã„å½¢â€ã«ã—ã¦ãŠãã“ã¨**ã ã‚ˆğŸ›¡ï¸

å†…å´ã®ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆã®ã‚³ãƒ„ğŸ‘‡

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã§æ„å‘³ãŒå¼·ã„å€¤ã¯ã€ã§ãã‚Œã° **Value Objectã£ã½ã**ã™ã‚‹ï¼ˆä¾‹ï¼šMoneyï¼‰ğŸª™
* çŠ¶æ…‹ã¯ **å†…å´ã®è¨€è‘‰ã§ enumåŒ–**ã—ã¦ãŠãğŸš¦
* æ¬ æã‚’è¨±ã™ã‹ã¯ **å…¥å£ã§æ±ºã‚ã‚‹**ï¼ˆä¸­ã§ã¯æ›–æ˜§ã«ã—ãªã„ï¼‰ğŸ”’

---

## 4. å¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ã‚’ä½œã‚ã†ğŸ§¾âœï¸ï¼ˆã“ã‚ŒãŒACLã®è¨­è¨ˆå›³ï¼‰

ACLã¯ã€Œå¤‰æ›ã®ãƒ«ãƒ¼ãƒ«ãŒå‘½ã€ğŸ’“
ã ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã®å‰ã«ã€ã¾ãš **å¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨**ã‚’ä½œã‚‹ã®ãŒå¼·ã„ã‚ˆğŸ’ªâœ¨

ãƒ†ãƒ³ãƒ—ãƒ¬ğŸ‘‡ï¼ˆã“ã‚Œã‚’åŸ‹ã‚ã‚‹ã ã‘ã§è¨­è¨ˆãŒé€²ã‚€ï¼ï¼‰

* å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼š
* å†…éƒ¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼š
* å¤‰æ›ãƒ«ãƒ¼ãƒ«ï¼š
* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼š
* æ¬ ææ™‚ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ / ã‚¨ãƒ©ãƒ¼ / ä¿ç•™
* ä¾‹å¤–æ™‚ï¼šã©ã®å†…å´ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ï¼Ÿ
* å‚™è€ƒï¼šå°†æ¥ã®å¤‰æ›´ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³å·®ãªã©ï¼‰

---

## 5. ã€Œã©ã“ã§ç¿»è¨³ã™ã‚‹ï¼Ÿã€ç½®ãå ´æ‰€ã®åŸå‰‡ğŸ“ğŸ§­

ACLã®ç½®ãå ´æ‰€ã¯ã€åŸºæœ¬ã“ã†è€ƒãˆã‚‹ã¨è¿·ã„ã«ãã„ã‚ˆğŸ‘‡

* **å¤–éƒ¨DTOã‚’èª­ã‚€å ´æ‰€ï¼ACL**ï¼ˆå…¥å£ã§ç¿»è¨³ï¼‰ğŸšª
* **å†…å´ãƒ¢ãƒ‡ãƒ«ã‚’å¤–ã¸å‡ºã™å ´æ‰€ï¼ACL**ï¼ˆå‡ºå£ã§ç¿»è¨³ï¼‰ğŸ“¤
* å†…å´ã®ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã¯ã€å¤–éƒ¨DTOã‚’ **çµ¶å¯¾ã«çŸ¥ã‚‰ãªã„**ğŸ™…â€â™€ï¸

```mermaid
flowchart TD
    Client[å¤–éƒ¨/ä»–BC] -- "External DTO" --> ACL_In["ğŸšª ACL (å…¥å£)"]
    ACL_In -- "Internal Model" --> Domain["ğŸ  ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯"]
    Domain -- "Internal Model" --> ACL_Out["ğŸ“¤ ACL (å‡ºå£)"]
    ACL_Out -- "External DTO" --> Client
    
    subgraph BC_Internal [BCå†…éƒ¨]
        ACL_In
        Domain
        ACL_Out
    end
```

ãƒ•ã‚©ãƒ«ãƒ€ä¾‹ï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ğŸ“âœ¨

* `contexts/shipping/`

  * `domain/`ï¼ˆå†…å´ãƒ¢ãƒ‡ãƒ«ï¼‰
  * `application/`ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰
  * `integration/`

    * `externalCarrier/`

      * `externalDto.ts`ï¼ˆå¤–éƒ¨ã®å‹ï¼‰
      * `translator.ts`ï¼ˆç¿»è¨³ï¼‰
      * `client.ts`ï¼ˆé€šä¿¡ï¼‰

---

## 6. ãƒŸãƒ‹ä¾‹é¡Œï¼šå¤–éƒ¨é…é€APIã‚’ç¿»è¨³ã™ã‚‹ğŸššğŸ“¦ğŸ§¼

### 6-1. å¤–éƒ¨DTOï¼ˆä¾‹ï¼‰ğŸŒ

å¤–éƒ¨ã¯ã“ã†ã„ã†å½¢ã§è¿”ã—ã¦ãã‚‹ã¨ã™ã‚‹ã­ğŸ‘‡ï¼ˆsnake_caseã€å˜ä½ãŒé•ã†ã€nullableã‚ã‚Šâ€¦ãªã©â€œå¤–éƒ¨ã£ã½ã•â€æº€è¼‰ğŸ˜‡ï¼‰

```ts
// externalDto.ts
export type ExternalShipmentStatus = "IN_TRANSIT" | "DELIVERED" | "CANCELLED";

export interface ExternalShipmentDto {
  shipment_id: string;
  status: ExternalShipmentStatus;
  shipping_fee_cents: number;
  weight_grams?: number | null;
  delivered_at?: string | null; // ISOæ–‡å­—åˆ—ã®ã¤ã‚‚ã‚Š
}
```

### 6-2. å†…å´ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹ï¼‰ğŸ 

å†…å´ã¯ã€Œæ„å‘³ãŒã‚ã‹ã‚Šã‚„ã™ã„å½¢ã€ã«å¯„ã›ãŸã„ğŸ˜Šâœ¨

```ts
// domain.ts
export type Currency = "JPY";

export type Money = {
  amount: number;     // ä¾‹: 1200
  currency: Currency; // ä¾‹: "JPY"
};

export enum ShippingStatus {
  InDelivery = "InDelivery",
  Delivered = "Delivered",
  Cancelled = "Cancelled",
}

export type Shipment = {
  id: string;
  status: ShippingStatus;
  fee: Money;
  weightKg?: number;         // ä»»æ„ï¼ˆãªã„ã“ã¨ã‚‚ã‚ã‚‹ï¼‰
  deliveredAt?: Date;        // ä»»æ„ï¼ˆæœªé…é”ãªã‚‰ãªã„ï¼‰
};
```

### 6-3. å¤‰æ›ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã®ç« ã®ä¸»å½¹ï¼ï¼‰ğŸ§¾ğŸ”¥

* `shipment_id` â†’ `id`ï¼ˆåå‰å¤‰æ›ï¼‰
* `status` â†’ `ShippingStatus`ï¼ˆå¯¾å¿œè¡¨ã§å¤‰æ›ï¼‰
* `shipping_fee_cents` â†’ `fee.amount`ï¼ˆé€šè²¨ã¯å›ºå®šJPYã¨ã—ã¦æ‰±ã†ï¼‰
* `weight_grams` â†’ `weightKg`ï¼ˆ`/1000`ã€ãªã‘ã‚Œã°`undefined`ï¼‰
* `delivered_at` â†’ `deliveredAt`ï¼ˆISOæ–‡å­—åˆ—â†’Dateã€å¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ï¼‰

### 6-4. ç¿»è¨³ã‚³ãƒ¼ãƒ‰ï¼ˆDTO â†’ å†…å´ï¼‰ğŸ§¼â¡ï¸ğŸ 

åˆå¿ƒè€…ã§ã‚‚æ‰±ã„ã‚„ã™ã„ã‚ˆã†ã«ã€Resultå‹ã£ã½ã„å½¢ã«ã—ã¦ã¿ã‚‹ã‚ˆğŸ˜Š

```ts
// translator.ts
import { ShippingStatus, type Shipment, type Money } from "../domain/domain";
import type { ExternalShipmentDto } from "./externalDto";

type Ok<T> = { ok: true; value: T };
type Err = { ok: false; reason: string };
type Result<T> = Ok<T> | Err;

function centsToMoneyJPY(cents: number): Money {
  // å¤–ã®å˜ä½ï¼ˆcentsï¼‰ã‚’å†…ã®å½¢ã¸
  return { amount: Math.round(cents), currency: "JPY" };
}

function gramsToKg(grams: number): number {
  return grams / 1000;
}

function mapStatus(s: ExternalShipmentDto["status"]): Result<ShippingStatus> {
  switch (s) {
    case "IN_TRANSIT":
      return { ok: true, value: ShippingStatus.InDelivery };
    case "DELIVERED":
      return { ok: true, value: ShippingStatus.Delivered };
    case "CANCELLED":
      return { ok: true, value: ShippingStatus.Cancelled };
    default:
      // ã“ã“ã«æ¥ãŸã‚‰ã€Œå¤–ãŒå¢—ãˆãŸã€å¯èƒ½æ€§ãŒé«˜ã„
      return { ok: false, reason: `Unknown external status: ${String(s)}` };
  }
}

export function toDomainShipment(dto: ExternalShipmentDto): Result<Shipment> {
  if (!dto.shipment_id) return { ok: false, reason: "shipment_id is required" };

  const statusR = mapStatus(dto.status);
  if (!statusR.ok) return statusR;

  let deliveredAt: Date | undefined;
  if (dto.delivered_at) {
    const d = new Date(dto.delivered_at);
    if (Number.isNaN(d.getTime())) {
      return { ok: false, reason: "delivered_at is invalid ISO date string" };
    }
    deliveredAt = d;
  }

  const weightKg =
    dto.weight_grams == null ? undefined : gramsToKg(dto.weight_grams);

  return {
    ok: true,
    value: {
      id: dto.shipment_id,
      status: statusR.value,
      fee: centsToMoneyJPY(dto.shipping_fee_cents),
      weightKg,
      deliveredAt,
    },
  };
}
```

ãƒã‚¤ãƒ³ãƒˆğŸŒŸ

* **å¤–éƒ¨ã®å¢—åˆ†ï¼ˆstatusè¿½åŠ ï¼‰**ã¯ã€`default`ã§æ¤œå‡ºã—ã¦è½ã¨ã™ï¼ˆæ°—ã¥ã‘ã‚‹ï¼ï¼‰ğŸ‘€
* å˜ä½å¤‰æ›ã¯ **å¿…ãšACLã§**ï¼ˆå†…å´ã§æ•£ã‚‰ã°ã‚‰ãªã„ï¼‰ğŸ§¼
* æ—¥ä»˜ã¯ **ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã‚’æ¡ã‚Šã¤ã¶ã•ãªã„**ï¼ˆåœ°ç„ã®ãƒã‚°ã«ãªã‚‹ğŸ˜±ï¼‰

---

## 7. ã‚¨ãƒ©ãƒ¼ç¿»è¨³ï¼šå¤–ã®å¤±æ•—ã‚’å†…å´ã®è¨€è‘‰ã«ã™ã‚‹ğŸš¨â¡ï¸ğŸ§¸

ACLã¯ãƒ‡ãƒ¼ã‚¿ã ã‘ã˜ã‚ƒãªãã€**å¤±æ•—ã®ç¿»è¨³**ã‚‚å¤§äº‹ã ã‚ˆğŸ›¡ï¸
ãŸã¨ãˆã°å¤–éƒ¨HTTPã‚¨ãƒ©ãƒ¼ã‚’ã€å†…å´ã§ã“ã†åˆ†é¡ã§ãã‚‹ã¨æ‰±ã„ã‚„ã™ã„ğŸ‘‡

* å…¥åŠ›ãŒæ‚ªã„ï¼š`BadRequest`ï¼ˆç›´ã—ã¦å†å®Ÿè¡Œï¼‰âœï¸
* èªè¨¼/èªå¯ï¼š`Unauthorized`ï¼ˆè¨­å®šã‚„æ¨©é™ã®å•é¡Œï¼‰ğŸ”‘
* ä¸€æ™‚çš„ï¼š`TemporaryUnavailable`ï¼ˆãƒªãƒˆãƒ©ã‚¤å€™è£œï¼‰â³
* ç«¶åˆï¼š`Conflict`ï¼ˆçŠ¶æ…‹ãŒã‚ºãƒ¬ã¦ã‚‹ï¼‰ğŸ§©
* ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼š`RateLimited`ï¼ˆå¾…ã£ã¦ã‹ã‚‰ï¼‰ğŸ¢

ä¾‹ï¼ˆè¶…ã–ã£ãã‚Šï¼‰ğŸ‘‡

```ts
export type DomainError =
  | { type: "BadRequest"; message: string }
  | { type: "Unauthorized"; message: string }
  | { type: "RateLimited"; retryAfterSec?: number }
  | { type: "TemporaryUnavailable"; message: string }
  | { type: "Conflict"; message: string };

export function mapHttpToDomainError(status: number): DomainError {
  if (status === 400) return { type: "BadRequest", message: "invalid request" };
  if (status === 401 || status === 403) return { type: "Unauthorized", message: "auth failed" };
  if (status === 409) return { type: "Conflict", message: "state conflict" };
  if (status === 429) return { type: "RateLimited" };
  if (status >= 500) return { type: "TemporaryUnavailable", message: "external service down" };
  return { type: "TemporaryUnavailable", message: "unexpected error" };
}
```

---

## 8. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ï¼šACLã¯â€œãƒ†ã‚¹ãƒˆãŒæœ¬ä½“â€ğŸ§ªğŸ›¡ï¸

ACLã¯ã€Œå¤–ã®å¤‰æ›´ã€ãŒä¸€ç•ªåˆºã•ã‚‹å ´æ‰€âš ï¸
ã ã‹ã‚‰ãƒ†ã‚¹ãƒˆã®å®ˆã‚ŠãŒè¶…å¤§äº‹ã ã‚ˆğŸ˜Š

ãŠã™ã™ã‚3ç‚¹ã‚»ãƒƒãƒˆğŸ‘‡

1. **å¤‰æ›ãƒ†ã‚¹ãƒˆï¼ˆmapperã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼‰**ï¼šå…¥åŠ›â†’å‡ºåŠ›ãŒå›ºå®šã•ã‚Œã‚‹âœ…
2. **ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ä¾‹ï¼‰**ï¼šå¤–éƒ¨ãŒå¤‰ã‚ã£ãŸã‚‰å·®åˆ†ãŒè¦‹ãˆã‚‹ğŸ“¸
3. **æœªçŸ¥ã®å€¤ãƒ†ã‚¹ãƒˆ**ï¼š`status`ãŒå¢—ãˆãŸã‚‰è½ã¡ã‚‹ã“ã¨ã‚’ä¿è¨¼ğŸ‘€

ã‚³ãƒ„ğŸŒŸ

* â€œè½ã¡ã¦æ°—ã¥ã‘ã‚‹â€ã®ã¯æ­£ç¾©ï¼ˆé™ã‹ã«å£Šã‚Œã‚‹æ–¹ãŒæ€–ã„ï¼‰ğŸ˜±
* å¤‰æ›ãƒ†ã‚¹ãƒˆã¯ **å¢ƒç•Œã®å¥‘ç´„**ã ã¨æ€ã£ã¦å¤§äº‹ã«ã™ã‚‹ğŸ§¾âœ¨

---

## 9. ã‚ˆãã‚ã‚‹äº‹æ•…ğŸ˜‡â¡ï¸ğŸ˜±ï¼ˆãã—ã¦å¯¾ç­–ğŸ›¡ï¸ï¼‰

### äº‹æ•…1ï¼šå¤–éƒ¨DTOã‚’å†…å´ã§ä½¿ã„å›ã™ğŸ§Ÿâ€â™€ï¸

* ç—‡çŠ¶ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ãŒ `ExternalShipmentDto` ã‚’importã—å§‹ã‚ã‚‹
* çµæœï¼šå¤–éƒ¨å¤‰æ›´ã§å†…å´ãŒå£Šã‚Œã‚‹ğŸ’¥

âœ… å¯¾ç­–ï¼š**å¤–éƒ¨DTOã®importã¯ACLé…ä¸‹ã ã‘**ã«ç¸›ã‚‹ğŸ”’

### äº‹æ•…2ï¼šå¤‰æ›ãŒã‚ã¡ã“ã¡ã«æ•£ã‚‹ğŸŒ€

* ç—‡çŠ¶ï¼šcontrollerã§å¤‰æ›ã€usecaseã§å¤‰æ›ã€repositoryã§å¤‰æ›â€¦
* çµæœï¼šãƒ«ãƒ¼ãƒ«ãŒä¸€è‡´ã—ãªããªã‚‹ğŸ˜µ

âœ… å¯¾ç­–ï¼š**å¤‰æ›ã¯translatorã«é›†ç´„**ğŸ“¦

### äº‹æ•…3ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’â€œãã®ã¾ã¾â€é€šã™ğŸš¦ğŸ’£

* ç—‡çŠ¶ï¼š`"IN_TRANSIT"` ã‚’ãã®ã¾ã¾å†…éƒ¨ã§æŒã¤
* çµæœï¼šå†…å´ã®è¨€è‘‰ãŒå¤–ã«æ”¯é…ã•ã‚Œã‚‹ğŸ˜‡

âœ… å¯¾ç­–ï¼š**å¯¾å¿œè¡¨ï¼ˆmapï¼‰ã§å¿…ãšå¤‰æ›**ğŸ§¼

---

## 10. æ¼”ç¿’ğŸ’ªğŸ“šï¼ˆã‚„ã£ã¦èº«ã«ã¤ã‘ã‚ˆã†âœ¨ï¼‰

### æ¼”ç¿’Aï¼šå·®åˆ†ãƒªã‚¹ãƒˆã‚’ä½œã‚‹ğŸ“

å¤–éƒ¨APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ã‚’1ã¤æƒ³åƒã—ã¦ã€å·®åˆ†ã‚’10å€‹æ›¸ã“ã†ğŸ‘‡
ï¼ˆå‘½å/å‹/å˜ä½/çŠ¶æ…‹/æ¬ æ/ã‚¨ãƒ©ãƒ¼â€¦ã‹ã‚‰æ‹¾ã†ã¨ãƒ©ã‚¯ï¼ï¼‰

### æ¼”ç¿’Bï¼šå¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ã‚’åŸ‹ã‚ã‚‹ğŸ§¾

ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆå¤–â†’å†…ã€æ¬ ææ™‚ã€ã‚¨ãƒ©ãƒ¼æ™‚ï¼‰ã‚’åŸ‹ã‚ã¦ã¿ã‚ˆã†ğŸ˜Š

### æ¼”ç¿’Cï¼šæœªçŸ¥ã®statusã«å¼·ã„å¤‰æ›ã‚’ä½œã‚‹ğŸ‘€

`"RETURNED"` ãŒçªç„¶æ¥ãŸã‚‰ã©ã†ã™ã‚‹ï¼Ÿ

* â€œè½ã¨ã—ã¦æ°—ã¥ãâ€
* â€œUnknownã«è½ã¨ã™â€
  ã©ã£ã¡ãŒè‰¯ã„ã‹ã€ç†ç”±ã‚‚æ›¸ã“ã†âœï¸

### æ¼”ç¿’Dï¼šå¤‰æ›ãƒ†ã‚¹ãƒˆã‚’æ›¸ãğŸ§ª

* æ­£å¸¸ç³»ï¼š`DELIVERED` â†’ `ShippingStatus.Delivered`
* ç•°å¸¸ç³»ï¼šæœªçŸ¥ã®statusã§ `ok: false` ã«ãªã‚‹

---

## 11. AIç›¸æ£’ã«èããƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ¤–âœ¨

ãã®ã¾ã¾è²¼ã£ã¦ä½¿ãˆã‚‹ã‚„ã¤ç½®ã„ã¨ãã­ğŸ˜ŠğŸ’•

* ã€Œã“ã®å¤–éƒ¨DTOã‚’å†…å´ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã—ãŸã„ã€‚å·®åˆ†ï¼ˆå‘½å/å˜ä½/çŠ¶æ…‹/æ¬ æ/ã‚¨ãƒ©ãƒ¼ï¼‰ã‚’ç®‡æ¡æ›¸ãã§å‡ºã—ã¦ã€
* ã€Œstatuså¯¾å¿œè¡¨ã‚’ä½œã£ã¦ã€‚æœªçŸ¥ã®å€¤ãŒæ¥ãŸã¨ãã®æ–¹é‡ã‚‚2æ¡ˆå‡ºã—ã¦ã€
* ã€Œtranslator.tsã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ¡ˆã‚’3ã‚±ãƒ¼ã‚¹ï¼ˆæ­£å¸¸/æ¬ æ/æœªçŸ¥ï¼‰ã§ææ¡ˆã—ã¦ã€
* ã€Œå¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã€ã“ã®ã‚±ãƒ¼ã‚¹ã§åŸ‹ã‚ã¦ã€

---

## 12. ã¾ã¨ã‚ğŸ§¾âœ¨

* ACLã¯ **å¤–ã®ã‚¯ã‚»ã‚’â€œç¿»è¨³â€ã—ã¦ã€å†…å´ã‚’å®ˆã‚‹å£**ğŸ§±ğŸ›¡ï¸([microservices.io][1])
* è¨­è¨ˆã¯ **å·®åˆ†ã®æ£šå¸ã— â†’ å¤‰æ›ãƒ«ãƒ¼ãƒ«è¡¨ â†’ å¤‰æ›ã‚³ãƒ¼ãƒ‰**ã®é †ãŒå¼·ã„ğŸ“‹ğŸ§¾ğŸ’»
* å¤‰æ›ã¯æ•£ã‚‰ã°ã‚‰ã›ãš **ACLã«é›†ç´„**ğŸ“¦âœ¨
* ACLã¯å¤–éƒ¨å¤‰æ›´ãŒåˆºã•ã‚‹ã®ã§ **ãƒ†ã‚¹ãƒˆã§å®ˆã‚‹**ã®ãŒè¶…å¤§äº‹ğŸ§ªğŸ›¡ï¸

---

## è£œè¶³ï¼šTypeScriptã®è¶³å…ƒï¼ˆ2026/02/02æ™‚ç‚¹ï¼‰ğŸ§¸ğŸ’»

ã‚µãƒ³ãƒ—ãƒ«ã®æ›¸ãæ–¹ã¯TypeScriptã®å®‰å®šç‰ˆãƒ©ã‚¤ãƒ³ï¼ˆ5.9ç³»ï¼‰ã§æ™®é€šã«OKã ã‚ˆğŸ˜Š
npmã® `typescript` ã¯ 5.9.3 ãŒ latest ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã€‚([NPM][3])
ã‚ã¨ã€TypeScriptã®ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ@typescript/native-previewï¼‰ã‚„ã€TypeScript 7ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–åŒ–ï¼‰ã®é€²æ—ã‚‚å…¬å¼ãƒ–ãƒ­ã‚°ã§ç¶™ç¶šçš„ã«å…±æœ‰ã•ã‚Œã¦ã‚‹ã‚ˆğŸŒ±ğŸš€([devblogs.microsoft.com][4])

[1]: https://microservices.io/patterns/refactoring/anti-corruption-layer.html?utm_source=chatgpt.com "Pattern: Anti-corruption layer"
[2]: https://martinfowler.com/articles/patterns-legacy-displacement/legacy-mimic.html?utm_source=chatgpt.com "Legacy Mimic"
[3]: https://www.npmjs.com/package/typescript?utm_source=chatgpt.com "TypeScript"
[4]: https://devblogs.microsoft.com/typescript/announcing-typescript-native-previews/?utm_source=chatgpt.com "Announcing TypeScript Native Previews"
