# ç¬¬4ç« ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ç¾å®Ÿï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»åˆ‡æ–­ãƒ»å†é€ï¼‰ğŸ”ŒğŸ“¨

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ« ğŸ¯âœ¨

* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€Œå¤±æ•—ã€ã˜ã‚ƒãªãã¦ã€Œæ™‚é–“åˆ‡ã‚Œåˆ¤å®šã€ã ã¨ä½“ã«å…¥ã‚Œã‚‹â³ğŸ§ 
* åˆ‡æ–­ã‚„ã‚¨ãƒ©ãƒ¼ã¯â€œãŸã¾ã«â€ã˜ã‚ƒãªãã¦â€œæ™®é€šã«â€èµ·ãã‚‹å‰æã‚’ä½œã‚‹ğŸ“‰âš¡
* ãƒªãƒˆãƒ©ã‚¤ï¼ˆå†é€ï¼‰ã§**äºŒé‡å®Ÿè¡Œ**ãŒèµ·ãã‚‹ã®ã‚’ã€æ‰‹ã‚’å‹•ã‹ã—ã¦ä½“é¨“ã™ã‚‹ğŸ”ğŸ˜±
* ã€Œã˜ã‚ƒã‚è¨­è¨ˆã¯ã©ã†ã™ã‚‹ï¼Ÿã€ã®å…¥å£ï¼ˆæ¬¡ç« ä»¥é™ã®ä¼ç·šï¼‰ã‚’ä½œã‚‹ğŸ§©ğŸšª

![ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ•…éšœ](./picture/cap_ts_study_004_network_fault.png)

---

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã£ã¦ã€ã©ã‚“ãªãµã†ã«å£Šã‚Œã‚‹ã®ï¼ŸğŸŒğŸ’¥

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¶Šã—ã®å‘¼ã³å‡ºã—ï¼ˆHTTPã¨ã‹ï¼‰ã¯ã€ã ã„ãŸã„ã“ã†ã„ã†äº‹ä»¶ãŒèµ·ãã¾ã™ğŸ‘‡ğŸ˜µâ€ğŸ’«

* **é…ã„**ï¼šè¿”äº‹ãŒæ¥ã‚‹ã¾ã§æ•°ç§’ã€œæ•°åç§’å¾…ã¤ğŸ¢
* **é€”ä¸­ã§åˆ‡ã‚Œã‚‹**ï¼šç›¸æ‰‹ã¯ç”Ÿãã¦ã‚‹ã®ã«ã€ç·šã ã‘åˆ‡ã‚Œã‚‹âœ‚ï¸
* **ç›¸æ‰‹ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™**ï¼š500 / 503 / 429 ãªã©ğŸ§¯
* **è¿”äº‹ãŒæ¥ãŸã‘ã©ä¸­èº«ãŒãŠã‹ã—ã„**ï¼šéƒ¨åˆ†çš„ã«å£Šã‚ŒãŸJSONã¨ã‹ğŸ“¦ğŸ’”
* **ã“ã£ã¡ãŒè«¦ã‚ãŸã‘ã©ç›¸æ‰‹ã¯å‡¦ç†ã—ã¦ãŸ**ï¼šã“ã‚ŒãŒåœ°ç„ã®å…¥å£ğŸ‘»

ã“ã®ç« ã¯æœ€å¾Œã®ã‚„ã¤ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ†’ãƒªãƒˆãƒ©ã‚¤â†’äºŒé‡å®Ÿè¡Œï¼‰ã‚’â€œã‚ã–ã¨â€èµ·ã“ã—ã¦å­¦ã³ã¾ã™ğŸ§ªğŸ²
ã€ŒFault Injectionï¼ˆæ•…éšœæ³¨å…¥ï¼‰ã€ã£ã¦å‘¼ã°ã‚Œã‚‹è€ƒãˆæ–¹ã§ã€ã‚ã–ã¨å¤±æ•—ã‚’æ··ãœã¦å¼·ãã™ã‚‹ã‚„ã¤ã ã‚ˆğŸ’ªğŸ§ª ([Microsoft GitHub][1])

---

## ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æ­£ä½“ â³ğŸ§©

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã–ã£ãã‚Šè¨€ã†ã¨ã“ã†ğŸ‘‡

> **ã€Œç›¸æ‰‹ãŒå¤±æ•—ã—ãŸã€ã®ã§ã¯ãªãã€ã“ã¡ã‚‰ãŒâ€œå¾…ã¤ã®ã‚’ã‚„ã‚ãŸâ€ã ã‘** ğŸ˜­

ã¤ã¾ã‚Šã€ã“ã£ã¡ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸç¬é–“ã«ç›¸æ‰‹ãŒæ­¢ã¾ã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“âš ï¸
ç›¸æ‰‹ãŒãã®ã¾ã¾å‡¦ç†ã‚’ç¶šã‘ã¦ã€**ã‚ã¨ã§å®Œäº†ã—ã¦ã—ã¾ã†**ã“ã¨ãŒæ™®é€šã«ã‚ã‚Šã¾ã™ï¼ˆãã—ã¦äºŒé‡å®Ÿè¡Œã®æ¸©åºŠï¼‰ğŸ˜±ğŸ”¥

```mermaid
sequenceDiagram
    participant C as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant N as ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    participant S as ã‚µãƒ¼ãƒãƒ¼

    C->>N: 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
    N->>S: 2. ã‚µãƒ¼ãƒãƒ¼ã«åˆ°é”
    Note over S: 3. å‡¦ç†ä¸­...(é…ã„)
    Note over C: 4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¤å®šâ°
    C-->>C: è«¦ã‚ã¦æ¬¡ã®å‡¦ç†ã¸
    Note over S: 5. å‡¦ç†å®Œäº†ï¼âœ…
    S->>N: 6. ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡
    N--xC: (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã‚‚ã†èã„ã¦ãªã„)
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼ˆå‘¼ã¶å´ï¼‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

Node.js ã® `fetch` ã¯ **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã›ã‚“**ï¼ˆå¾…ã¦ã‚‹ã ã‘å¾…ã¤ï¼‰ã®ã§ã€è‡ªåˆ†ã§â€œç· åˆ‡â€ã‚’ã¤ã‘ã‚‹ã®ãŒå¤§äº‹ã ã‚ˆâ°
`AbortSignal.timeout(ms)` ãŒä½¿ãˆã‚‹ã®ã§ã€ã“ã‚Œã§ã€Œâ—‹ms ã§è«¦ã‚ã‚‹ã€ã‚’ä½œã‚Œã¾ã™ğŸ§· ([nodejs.org][2])

ã¡ãªã¿ã« Node.js ã® `fetch` ã¯ Undici ãŒä¸­ã§å‹•ã„ã¦ã‚‹ã‚ˆï¼ˆé«˜é€Ÿï¼†ä»•æ§˜æº–æ‹ ã‚’é ‘å¼µã£ã¦ã‚‹ã‚„ã¤ï¼‰ğŸš€ ([nodejs.org][3])

### ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆå—ã‘ã‚‹å´ï¼‰ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

ã‚µãƒ¼ãƒãƒ¼ã‚‚ã€Œã„ã¤ã¾ã§ã‚‚å—ã‘å–ã‚Šç¶šã‘ã‚‹ã¨å±ãªã„ã€ã®ã§ã€å—ä¿¡ã®ç· åˆ‡ã‚’æŒã¦ã¾ã™ã€‚Node ã® `server.requestTimeout` ã¯ã€æœŸé™ãŒåˆ‡ã‚Œã‚‹ã¨ 408 ã‚’è¿”ã—ã¦æ¥ç¶šã‚’é–‰ã˜ã‚‹â€¦ã¿ãŸã„ãªæŒ™å‹•ãŒã‚ã‚Šã¾ã™ğŸ›¡ï¸ ([nodejs.org][4])

---

## ãƒªãƒˆãƒ©ã‚¤ï¼ˆå†é€ï¼‰ã®ç½ ï¼šäºŒé‡ã«ãªã‚‹ ğŸ˜±ğŸ”

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ã€äººã¯ã“ã†è€ƒãˆãŒã¡ğŸ‘‡

* ã€Œè¿”äº‹ãªã„ï¼å¤±æ•—ã—ãŸã‚“ã ï¼ã€
* ã€Œã‚‚ã†ä¸€å›é€ã‚ï¼ã€

ã§ã‚‚ç¾å®Ÿã¯ã“ã†ã‹ã‚‚ğŸ‘‡ğŸ‘»

* 1å›ç›®ï¼šç›¸æ‰‹ã¯**å‡¦ç†ã—ã¦ãŸ**ï¼ˆãŸã è¿”äº‹ãŒé…ã‹ã£ãŸã ã‘ï¼‰
* 2å›ç›®ï¼šã‚‚ã†ä¸€å›æ¥ãŸã‹ã‚‰**ã‚‚ã†ä¸€å›å‡¦ç†ã—ãŸ**
* çµæœï¼š**äºŒé‡èª²é‡‘ğŸ’¸ / äºŒé‡æ³¨æ–‡ğŸ›’ / äºŒé‡åœ¨åº«æ¸›ğŸ“¦**

ã˜ã‚ƒã‚ã€å®Ÿéš›ã«èµ·ã“ã—ã¦ã¿ã‚ˆã†ğŸ”¥ğŸ”¥ğŸ”¥

---

## ãƒãƒ³ã‚ºã‚ªãƒ³ï¼šãƒ©ãƒ³ãƒ€ãƒ å¤±æ•—ã‚¹ã‚¤ãƒƒãƒï¼ˆFault Injectionï¼‰ã‚’ä»˜ã‘ã‚‹ğŸ›ï¸ğŸ²

### ã§ãã‚ãŒã‚‹ã‚‚ã® ğŸ§±âœ¨

* `apps/api`ï¼šä¸å®‰å®šãª `/charge` ã‚’æŒã¤ï¼ˆé…å»¶ãƒ»500ãƒ»åˆ‡æ–­ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç™ºç”Ÿï¼‰ğŸ˜ˆ
* `apps/worker`ï¼š`/charge` ã‚’å‘¼ã¶ï¼ˆçŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‹ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰ğŸ“¨ğŸ”
* è¦³å¯Ÿï¼š**ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ†’ãƒªãƒˆãƒ©ã‚¤â†’å®Ÿã¯äºŒé‡ã§å‡¦ç†ã•ã‚Œã¦ãŸ** ã‚’ãƒ­ã‚°ã§è¦‹ã‚‹ğŸ•µï¸â€â™€ï¸

---

## 1) APIã«ã€Œä¸å®‰å®šãªèª²é‡‘ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œã‚‹ğŸ˜ˆğŸ’³

`apps/api/src/server.ts` ã‚’ä½œæˆï¼ˆã¾ãŸã¯ç½®ãæ›ãˆï¼‰ğŸ‘‡

```ts
import { createServer } from "node:http";
import type { IncomingMessage, ServerResponse } from "node:http";
import { randomUUID } from "node:crypto";

type ChargeRequest = {
  orderId: string;
  amount: number;
};

const chargeCountByOrderId = new Map<string, number>();

const sleep = (ms: number) => new Promise<void>((r) => setTimeout(r, ms));

function isFaultOn() {
  return process.env.FAULT === "1";
}

async function readJson<T>(req: IncomingMessage): Promise<T> {
  const chunks: Buffer[] = [];
  for await (const chunk of req) chunks.push(Buffer.from(chunk));
  const text = Buffer.concat(chunks).toString("utf-8");
  return JSON.parse(text) as T;
}

function writeJson(res: ServerResponse, statusCode: number, body: unknown) {
  res.statusCode = statusCode;
  res.setHeader("content-type", "application/json; charset=utf-8");
  res.end(JSON.stringify(body));
}

const server = createServer(async (req, res) => {
  const url = new URL(req.url ?? "/", "http://localhost");
  const method = req.method ?? "GET";

  // è¿½è·¡ã—ã‚„ã™ã„ã‚ˆã†ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ä»˜ã‘ã‚‹ï¼ˆç„¡ã‘ã‚Œã°ä½œã‚‹ï¼‰
  const requestId =
    (req.headers["x-request-id"]?.toString() ?? "").trim() || randomUUID();
  res.setHeader("x-request-id", requestId);

  if (method === "GET" && url.pathname === "/health") {
    return writeJson(res, 200, { ok: true });
  }

  if (method === "POST" && url.pathname === "/charge") {
    const startedAt = Date.now();

    // æ•…éšœæ³¨å…¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆONã®ã¨ãã ã‘ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
    const delayMs = isFaultOn()
      ? Math.random() < 0.45
        ? 1200 + Math.floor(Math.random() * 2500) // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’èª˜ç™ºã—ãŒã¡ãªé…å»¶
        : Math.floor(Math.random() * 150) // ã»ã¼å³ãƒ¬ã‚¹
      : 0;

    const will500 = isFaultOn() && Math.random() < 0.18; // ãŸã¾ã«500
    const willDrop = isFaultOn() && Math.random() < 0.08; // ãŸã¾ã«åˆ‡æ–­

    let body: ChargeRequest;
    try {
      body = await readJson<ChargeRequest>(req);
    } catch {
      return writeJson(res, 400, { error: "Invalid JSON", requestId });
    }

    // ã€Œå‡¦ç†ã€ã¯è¿”äº‹ã‚’è¿”ã™å‰ã«é€²ã‚€ã“ã¨ãŒã‚ã‚‹ã€ã‚’å†ç¾ã—ãŸã„ã®ã§â€¦
    // å…ˆã«é…å»¶ã—ã¦ã€ãã®å¾Œã«â€œèª²é‡‘ã‚«ã‚¦ãƒ³ãƒˆâ€ã‚’å¢—ã‚„ã™ï¼ˆè¿”äº‹ãŒè¿”ã›ãªãã¦ã‚‚å‡¦ç†ã¯é€²ã‚€æƒ³å®šï¼‰
    await sleep(delayMs);

    const prev = chargeCountByOrderId.get(body.orderId) ?? 0;
    const next = prev + 1;
    chargeCountByOrderId.set(body.orderId, next);

    const elapsed = Date.now() - startedAt;

    // ãƒ­ã‚°ã¯â€œäº‹å®Ÿâ€ã¨ã—ã¦æ®‹ã‚‹ï¼ˆè¿”äº‹ãŒè¿”ã›ãªãã¦ã‚‚ã€å‡¦ç†ã—ãŸè¨˜éŒ²ã¯æ®‹ã‚‹æ„Ÿã˜ï¼‰
    console.log(
      JSON.stringify({
        at: new Date().toISOString(),
        requestId,
        orderId: body.orderId,
        amount: body.amount,
        delayMs,
        will500,
        willDrop,
        chargedTimes: next,
        elapsedMs: elapsed,
      })
    );

    if (willDrop) {
      // è¿”äº‹ã®ç›´å‰ã«ç·šãŒåˆ‡ã‚ŒãŸæ„Ÿã˜
      req.socket.destroy();
      return;
    }

    if (will500) {
      return writeJson(res, 500, {
        error: "Temporary error (simulated)",
        requestId,
        orderId: body.orderId,
        chargedTimes: next, // 500ã§ã‚‚å‡¦ç†ã¯é€²ã‚“ã˜ã‚ƒã£ã¦ã‚‹æœ€æ‚ªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å†ç¾ğŸ˜±
      });
    }

    return writeJson(res, 200, {
      ok: true,
      requestId,
      orderId: body.orderId,
      chargedTimes: next,
      elapsedMs: elapsed,
    });
  }

  writeJson(res, 404, { error: "Not found" });
});

// ã‚µãƒ¼ãƒãƒ¼å´ã«ã‚‚ã€Œå—ä¿¡ã®ç· åˆ‡ã€ã‚’æŒã¦ã‚‹ï¼ˆDoSå¯¾ç­–ã«ã‚‚ãªã‚‹ï¼‰
// ã“ã“ã¯å­¦ç¿’ç”¨ã«çŸ­ã‚ã«ã—ã¦ãŠãï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ã­ï¼‰
server.requestTimeout = 10_000;

server.listen(3001, () => {
  console.log("API listening on http://localhost:3001");
  console.log("Try: GET /health, POST /charge");
});
```

ãƒã‚¤ãƒ³ãƒˆğŸ‘€âœ¨

* `FAULT=1` ã®ã¨ãã ã‘ã€**é…å»¶/500/åˆ‡æ–­**ãŒãƒ©ãƒ³ãƒ€ãƒ ã§æ··ã–ã‚‹ğŸ›ï¸ğŸ²
* ä¸€ç•ªã‚¤ãƒ¤ãªå†ç¾ã¨ã—ã¦ã€`will500` ã§ã‚‚ **èª²é‡‘ã‚«ã‚¦ãƒ³ãƒˆãŒé€²ã‚€**ã‚ˆã†ã«ã—ã¦ã‚‹ğŸ˜±

  * ç¾å®Ÿã§ã‚‚ã€Œè¿”äº‹ãŒå¤±æ•—ã§ã‚‚å‡¦ç†ã¯é€šã£ã¦ãŸã€äº‹æ•…ãŒã‚ã‚‹ã‹ã‚‰ã­â€¦ï¼ˆDBæ›´æ–°ã¯æ¸ˆã‚“ã§ãŸç­‰ï¼‰ğŸ’¥

---

## 2) Workerã«ã€ŒçŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‹ãƒªãƒˆãƒ©ã‚¤ã€ã‚’ä½œã‚‹ğŸ“¨â³ğŸ”

`apps/worker/src/run.ts` ã‚’ä½œæˆï¼ˆã¾ãŸã¯ç½®ãæ›ãˆï¼‰ğŸ‘‡

```ts
import { randomUUID } from "node:crypto";

const sleep = (ms: number) => new Promise<void>((r) => setTimeout(r, ms));

function isAbortLike(err: unknown) {
  // Node/Fetch ã ã¨ AbortError ã«ãªã‚‹ã“ã¨ãŒå¤šã„
  return (
    err instanceof Error &&
    (err.name === "AbortError" || /aborted|timeout/i.test(err.message))
  );
}

async function chargeOnce(orderId: string, amount: number, timeoutMs: number) {
  const requestId = randomUUID();

  const res = await fetch("http://localhost:3001/charge", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      "x-request-id": requestId, // ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã¨çªãåˆã‚ã›ã‚‹ç”¨ğŸ§µ
    },
    body: JSON.stringify({ orderId, amount }),
    signal: AbortSignal.timeout(timeoutMs),
  });

  const text = await res.text();
  let json: any;
  try {
    json = JSON.parse(text);
  } catch {
    json = { raw: text };
  }

  if (!res.ok) {
    const e = new Error(`HTTP ${res.status}`);
    (e as any).details = json;
    throw e;
  }

  return json as {
    ok: true;
    requestId: string;
    orderId: string;
    chargedTimes: number;
    elapsedMs: number;
  };
}

async function chargeWithRetry(orderId: string, amount: number) {
  const maxAttempts = 3;
  const timeoutMs = 800; // ã‚ã–ã¨çŸ­ãã™ã‚‹â³ï¼ˆé…å»¶ã«è² ã‘ã‚„ã™ã„ï¼‰

  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      console.log(`ğŸ§¾ attempt=${attempt} orderId=${orderId} charging...`);

      const result = await chargeOnce(orderId, amount, timeoutMs);

      console.log(
        `âœ… SUCCESS orderId=${result.orderId} chargedTimes=${result.chargedTimes} elapsedMs=${result.elapsedMs} (serverRequestId=${result.requestId})`
      );
      return result;
    } catch (err) {
      if (isAbortLike(err)) {
        console.log(`â° TIMEOUT! attempt=${attempt} â†’ retry...`);
      } else if (err instanceof Error && err.message.startsWith("HTTP 5")) {
        console.log(`ğŸ§¯ SERVER 5xx! attempt=${attempt} â†’ retry...`);
      } else if (err instanceof Error) {
        console.log(`ğŸ’¥ OTHER ERROR: ${err.message} (no retry)`);
        throw err;
      }

      if (attempt === maxAttempts) {
        console.log("ğŸ§¨ GIVE UP");
        throw err;
      }

      // é›‘ã«ã™ãå†é€ï¼ˆâ€œäºŒé‡â€ãŒèµ·ãã‚„ã™ã„ï¼‰ğŸ˜ˆ
      await sleep(150);
    }
  }

  throw new Error("unreachable");
}

async function main() {
  // â€œåŒã˜æ³¨æ–‡IDâ€ã§å‘¼ã¶ã®ãŒãƒã‚¤ãƒ³ãƒˆï¼ˆï¼äºŒé‡ãŒè¦‹ãˆã‚„ã™ã„ï¼‰ğŸ§·
  const orderId = "order-0001";
  const amount = 1200;

  console.log("ğŸš€ start worker");
  const result = await chargeWithRetry(orderId, amount);

  console.log("ğŸ‰ done", result);
}

main().catch((e) => {
  console.error("âŒ worker crashed", e);
  process.exitCode = 1;
});
```

---

## 3) å‹•ã‹ã™ï¼ˆã“ã“ãŒä¸€ç•ªãŠã‚‚ã—ã‚ã„ï¼‰ğŸ¤£ğŸ”¥

### APIã‚’èµ·å‹•ï¼ˆæ•…éšœæ³¨å…¥ONï¼‰ğŸ›ï¸

PowerShell ãªã‚‰ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡

* APIå´ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼š

  * `FAULT=1` ã‚’å…¥ã‚Œã¦èµ·å‹•ï¼ˆæ–¹æ³•ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«åˆã‚ã›ã¦OKï¼‰
  * ä¾‹ï¼š`$env:FAULT="1"` ã‚’ä»˜ã‘ã¦èµ·å‹•

APIãƒ­ã‚°ã«ã€`delayMs` ã‚„ `willDrop` ãŒå‡ºã‚Œã°æˆåŠŸã ã‚ˆâœ…âœ¨

### Workerã‚’èµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ğŸ“¨

Workerã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãŸã¾ã«ã“ã†ãªã‚‹ğŸ‘‡

* `â° TIMEOUT! â†’ retry...`
* `âœ… SUCCESS ... chargedTimes=2`  â† **ãˆï¼Ÿ 2ï¼Ÿï¼Ÿï¼ŸğŸ˜±**

ã“ã® `chargedTimes=2` ãŒè¦‹ãˆãŸã‚‰å‹ã¡ğŸ†âœ¨
ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‹ã‚‰å¤±æ•—ã€ã˜ã‚ƒãªãã¦ã€ã€Œè¿”äº‹ã‚’å¾…ã¦ãªã‹ã£ãŸã ã‘ã§å‡¦ç†ã¯é€²ã‚“ã§ãŸã€ãŒä½“é¨“ã§ããŸã£ã¦ã“ã¨ğŸ‰

---

## è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ­ã‚°ã§â€œçœŸå®Ÿâ€ã‚’è¦‹ã‚‹ï¼‰ğŸ•µï¸â€â™€ï¸ğŸ§µ

APIã®ãƒ­ã‚°ã¯ã“ã†ã„ã†JSONãŒå‡ºã‚‹ã¯ãšğŸ‘‡

* `requestId`ï¼šå„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è­˜åˆ¥å­ğŸªª
* `delayMs`ï¼šé…å»¶ãŒã©ã‚Œãã‚‰ã„å…¥ã£ãŸã‹ğŸ¢
* `chargedTimes`ï¼šåŒã˜ `orderId` ãŒä½•å›å‡¦ç†ã•ã‚ŒãŸã‹ğŸ˜±

ã“ã“ã§ã‚ˆãèµ·ãã‚‹ã®ãŒã“ã®æµã‚ŒğŸ‘‡

1. WorkerãŒ `attempt=1` ã‚’é€ã‚‹ğŸ“¨
2. APIãŒ `delayMs=2500` ã¨ã‹ã§é…ã„ğŸ¢
3. Workerã¯ `timeoutMs=800` ãªã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ°
4. WorkerãŒ `attempt=2` ã‚’é€ã‚‹ğŸ”
5. å®Ÿã¯ `attempt=1` ã‚‚é…ã‚Œã¦å‡¦ç†å®Œäº†ã—ã¦ãŸğŸ‘»
6. `chargedTimes=2`ï¼ˆäºŒé‡ï¼‰ğŸ’¥ğŸ’¸

```mermaid
sequenceDiagram
    participant W as Worker (Client)
    participant A as API (Server)

    W->>A: attempt=1 (Timeout: 800ms)
    Note over A: å‡¦ç†é–‹å§‹ (delay=2500ms)
    W-->>W: 800msçµŒé: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ°
    W->>A: attempt=2 (å†é€)
    Note over A: 1å›ç›®å®Œäº† (ChargedTimes=1)
    Note over A: 2å›ç›®å®Œäº† (ChargedTimes=2) ğŸ’¥
    A-->>W: SUCCESS (ChargedTimes=2)
```

---

## ä»Šæ—¥ã®è¶…é‡è¦ã¾ã¨ã‚ï¼ˆ3è¡Œï¼‰âœï¸âœ¨

* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€Œå¤±æ•—ã€ã˜ã‚ƒãªãã¦**ç· åˆ‡åˆ¤æ–­**â³
* ãƒªãƒˆãƒ©ã‚¤ã¯**æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã ã‹ã‚‰ã€æ™®é€šã«äºŒé‡ã«ãªã‚‹ğŸ”ğŸ˜±
* ã ã‹ã‚‰å‰¯ä½œç”¨ã®ã‚ã‚‹å‡¦ç†ã¯ã€å¾Œã§å­¦ã¶ **å†ªç­‰æ€§ï¼ˆIdempotencyï¼‰** ãŒå¿…è¦ã«ãªã‚‹ğŸ§·âœ…

---

## ğŸ’¡ãƒŸãƒ‹ãŠã¾ã‘ï¼šäºŒé‡ã‚’æ¸›ã‚‰ã™â€œè¶…ãƒ»ç°¡æ˜“ç‰ˆâ€ã®è€ƒãˆæ–¹ï¼ˆãƒãƒ©è¦‹ã›ï¼‰ğŸ‘€ğŸ§·

æœ¬æ ¼çš„ã«ã¯å¾Œã®ç« ã§ã‚„ã‚‹ã‘ã©ã€ç™ºæƒ³ã ã‘å…ˆã«è¨€ã†ã­ğŸ‘‡

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `Idempotency-Key` ã‚’ä»˜ã‘ã‚‹ğŸ—ï¸
* ã‚µãƒ¼ãƒãƒ¼ã¯ãã®ã‚­ãƒ¼ã‚’è¨˜éŒ²ã—ã¦ã€åŒã˜ã‚­ãƒ¼ãŒæ¥ãŸã‚‰**åŒã˜çµæœã‚’è¿”ã™**ï¼ˆäºŒå›å‡¦ç†ã—ãªã„ï¼‰ğŸ§·âœ…

ã“ã®ç« ã®å®Ÿé¨“ãŒã€Œã ã‹ã‚‰å¿…è¦ãªã‚“ã â€¦ï¼ã€ã£ã¦è…¹è½ã¡ã™ã‚‹ãŸã‚ã®å¸ƒçŸ³ã ã‚ˆğŸ§ âœ¨

---

## AIã§ã®å­¦ã³ã‚’åŠ é€Ÿã™ã‚‹ã‚³ãƒ¼ãƒŠãƒ¼ğŸ¤–ğŸ’¡

### ãã®1ï¼šæ•…éšœæ³¨å…¥ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã—ã¦ã‚‚ã‚‰ã†ğŸ²

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ğŸ‘‡

* ã€ŒHTTPã‚µãƒ¼ãƒãƒ¼ã« fault injection ã‚’å…¥ã‚ŒãŸã„ã€‚é…å»¶/500/åˆ‡æ–­/é…ã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹/å£Šã‚ŒãŸJSON ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’10å€‹å‡ºã—ã¦ã€ğŸ¤–ğŸ’­

### ãã®2ï¼šãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã‚‚ã‚‰ã†ğŸ”

* ã€Œã“ã®ãƒªãƒˆãƒ©ã‚¤å®Ÿè£…ã®å±é™ºç‚¹ã‚’åˆ—æŒ™ã—ã¦ã€‚äºŒé‡å®Ÿè¡Œãƒ»é›ªå´©ãƒªãƒˆãƒ©ã‚¤ãƒ»è² è·å¢—å¤§ã®è¦³ç‚¹ã§ã€ğŸ§¯ğŸ¤–

### ãã®3ï¼šãƒ­ã‚°ã®è¦‹æ–¹ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã†ğŸ•µï¸â€â™€ï¸

* ã€ŒrequestId ã¨ orderId ã§ã€äºŒé‡å®Ÿè¡ŒãŒèµ·ããŸæµã‚Œã‚’èª¬æ˜ã—ã¦ã€ğŸ§µğŸ¤–

---

## ãƒã‚§ãƒƒã‚¯å•é¡Œï¼ˆã‚µã‚¯ãƒƒã¨ï¼‰ğŸ“âœ¨

1. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã€Œç›¸æ‰‹ãŒå¤±æ•—ã—ãŸã€ã£ã¦æ„å‘³ï¼Ÿãã‚Œã¨ã‚‚â€¦ï¼Ÿâ³
2. 1å›ç›®ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚ã€ç›¸æ‰‹ãŒå‡¦ç†ã—ã¦ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã¯ãªãœï¼ŸğŸ‘»
3. ãƒªãƒˆãƒ©ã‚¤ã§äºŒé‡ãŒèµ·ãã‚‹ã¨å›°ã‚‹å…·ä½“ä¾‹ã‚’3ã¤è¨€ãˆã‚‹ï¼ŸğŸ’¸ğŸ“¦ğŸ›’
4. `chargedTimes=2` ãŒå‡ºãŸã¨ãã€ä½•ãŒèµ·ããŸã¨æ¨ç†ã§ãã‚‹ï¼ŸğŸ•µï¸â€â™€ï¸
5. äºŒé‡ã‚’é˜²ãæ–¹å‘æ€§ï¼ˆç™ºæƒ³ï¼‰ã¨ã—ã¦ã€ã©ã‚“ãªã‚­ãƒ¼ã‚’ä½¿ã†ï¼ŸğŸ—ï¸

---

## å‚è€ƒãƒ¡ãƒ¢ï¼ˆ2026-01-30æ™‚ç‚¹ï¼‰ğŸ“Œ

* Node.js ã¯ **v25ç³»ãŒ Current**ã€**v24ç³»ãŒ Active LTS**ï¼ˆå®‰å®šé‹ç”¨ã¯LTSã‚’é¸ã¶ã“ã¨ãŒå¤šã„ã‚ˆï¼‰ğŸŸ¢ ([nodejs.org][5])
* Node ã® `fetch` ã¯ Undici ãƒ™ãƒ¼ã‚¹ ğŸš€ ([nodejs.org][3])
* `AbortSignal.timeout()` ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ä½œã‚Œã‚‹â° ([nodejs.org][2])
* Node ã® `server.requestTimeout` ã¯å—ä¿¡ã®ç· åˆ‡ï¼ˆ408ã§é–‰ã˜ã‚‹ç­‰ï¼‰ğŸ›¡ï¸ ([nodejs.org][4])

[1]: https://microsoft.github.io/code-with-engineering-playbook/automated-testing/fault-injection-testing/?utm_source=chatgpt.com "Fault Injection Testing - Engineering Fundamentals Playbook"
[2]: https://nodejs.org/api/globals.html "Global objects | Node.js v25.5.0 Documentation"
[3]: https://nodejs.org/en/learn/getting-started/fetch "Node.js â€” Node.js Fetch"
[4]: https://nodejs.org/api/http.html "HTTP | Node.js v25.5.0 Documentation"
[5]: https://nodejs.org/en/about/previous-releases "Node.js â€” Node.js Releases"
