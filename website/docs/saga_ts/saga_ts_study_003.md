# ç¬¬3ç« ï¼šã€Œå…¨éƒ¨ã¾ã¨ã‚ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ã¯ãªãœé›£ã—ã„ï¼ŸğŸ§©ğŸ’¥

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯

* ã€ŒDBã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å…¨éƒ¨ã¾ã¨ã‚ã¦ã‚„ã‚Œã°å®‰å¿ƒâœ¨ã€ãŒã€**å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒ1ã¤å…¥ã£ãŸç¬é–“ã«å´©ã‚Œã‚‹ç†ç”±**ã‚’èª¬æ˜ã§ãã‚‹ğŸ˜Š
* å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦‹ã¦ã€SagaãŒå¿…è¦ã«ãªã‚‹â€œå…¥å£â€ã‚’ä½“æ„Ÿã™ã‚‹ğŸšªâœ¨

---

# 3-1. ã¾ãšã€ŒDB1ã¤ã ã‘ã€ã®ä¸–ç•Œã¯ã€ã‹ãªã‚Šå¹³å’ŒğŸï¸ğŸ§˜â€â™€ï¸

DBã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã£ã¦ã€ã–ã£ãã‚Šè¨€ã†ã¨ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡

* âœ… ã¾ã¨ã‚ã¦å®Ÿè¡Œã™ã‚‹ï¼ˆé€”ä¸­ã§å¤±æ•—ã—ãŸã‚‰å…¨éƒ¨ãªã‹ã£ãŸã“ã¨ã«ã§ãã‚‹ï¼‰
* âœ… â€œåŒã˜ç®±ï¼ˆDBï¼‰â€ã®ä¸­ã§ã€æ•´åˆæ€§ã‚’å®ˆã‚Œã‚‹
* âœ… ãƒ­ãƒƒã‚¯ã‚„åˆ¶ç´„ï¼ˆFK/Uniqueãªã©ï¼‰ã‚‚åŒã˜ä¸–ç•Œã§åŠ¹ã

ã ã‹ã‚‰ä¾‹ãˆã°â€¦

* æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT
* åœ¨åº«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’UPDATE
* å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«INSERT

ã¿ãŸã„ãªã€ŒåŒã˜DBå†…ã®æ“ä½œã€ãªã‚‰ã€ã†ã¾ãã¾ã¨ã¾ã‚‹ã“ã¨ãŒå¤šã„ã®ã­ğŸ˜Š

---

# 3-2. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒ1ã¤å…¥ã£ãŸç¬é–“ã€ä¸–ç•ŒãŒå¤‰ã‚ã‚‹ğŸŒâš¡

ãŸã¨ãˆã°æ³¨æ–‡ãƒ•ãƒ­ãƒ¼ã§ã€Œæ±ºæ¸ˆAPIï¼ˆå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã€ã‚’å‘¼ã¶ã¨ã™ã‚‹ã‚ˆã­ğŸ›’ğŸ’³
ã“ã®ç¬é–“ã‹ã‚‰ã€**DBã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã ã‘ã§ã¯å®ˆã‚Œãªã„äº‹æ•…**ãŒå¢—ãˆã‚‹ğŸ’¥

ãªãœã‹ã¨ã„ã†ã¨ã€åˆ†æ•£ã§ã¯ã€Œãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒä¿¡é ¼ã§ãã‚‹ã€ã€Œé…å»¶ãŒã‚¼ãƒ­ã€ã¿ãŸã„ãªå‰æãŒå´©ã‚Œã‚‹ã‹ã‚‰ğŸ˜µâ€ğŸ’«
æœ‰åãªâ€œåˆ†æ•£ã®è½ã¨ã—ç©´â€ã¨ã—ã¦ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯å£Šã‚Œã‚‹ã—ã€é…å»¶ã¯ã‚ã‚‹ã—ã€ç’°å¢ƒã¯å‡ä¸€ã˜ã‚ƒãªã„â€¦ã¿ãŸã„ãªå‰æå´©å£ŠãŒã¾ã¨ã¾ã£ã¦èªã‚‰ã‚Œã¦ã‚‹ã‚ˆğŸ“Œ ([ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢][1])

```mermaid
graph LR
  subgraph SingleDB ["å¹³å’ŒãªDB ğŸ§˜â€â™€ï¸"]
    DB[(Database)]
    App[ã‚¢ãƒ—ãƒª] --- DB
  end
  subgraph Distributed ["è©¦ç·´ã®åˆ†æ•£ä¸–ç•Œ ğŸŒâš¡"]
    Srv1[æ³¨æ–‡] -- "Network" --> Srv2[æ±ºæ¸ˆ]
    Srv1 -- "Network" --> Srv3[åœ¨åº«]
    style Srv1 fill:#f9f,stroke:#333
  end
```

---

# 3-3. äº‹æ•…ãƒ‘ã‚¿ãƒ¼ãƒ³å›³é‘‘ğŸ“šğŸ’¥ï¼ˆã“ã“ãŒSagaã®å…¥å£ï¼‰

## ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼šã€Œç›¸æ‰‹ã¯æˆåŠŸã—ãŸã®ã«ã€ã“ã£ã¡ã¯å¤±æ•—ã«è¦‹ãˆã‚‹ã€ğŸ˜±ğŸ“¡

æ±ºæ¸ˆAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã€‚
ã§ã‚‚è¿”äº‹ãŒé…ãã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆâ€¦â°

* ã‚ãªãŸï¼ˆæ³¨æ–‡ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ï¼šã€Œå¤±æ•—ã—ãŸï¼ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã‚ˆï¼ğŸ˜­ã€
* æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ï¼šã€ŒæˆåŠŸã—ãŸã‚ˆï¼èª²é‡‘ã—ã¡ã‚ƒã£ãŸã‚ˆï¼âœ…ğŸ’³ã€

çµæœğŸ‘‡
**æ³¨æ–‡ã¯ç„¡ã„ã®ã«èª²é‡‘ã ã‘ç™ºç”Ÿ**ï¼ˆæœ€æ‚ªï¼‰ğŸ˜‡ğŸ”¥

ã“ã‚Œã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒæ™®é€šã«èµ·ãã‚‹åˆ†æ•£ä¸–ç•Œã ã¨â€œã‚ã‚‹ã‚ã‚‹â€ãªã®ğŸ¥² ([ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢][1])

```mermaid
sequenceDiagram
    participant ã‚¢ãƒ—ãƒª
    participant æ±ºæ¸ˆAPI
    ã‚¢ãƒ—ãƒª->>æ±ºæ¸ˆAPI: 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ ğŸ’³
    Note right of æ±ºæ¸ˆAPI: 2. å‡¦ç†æˆåŠŸï¼âœ…
    æ±ºæ¸ˆAPI--xã‚¢ãƒ—ãƒª: 3. è¿”ä¿¡ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§æ¶ˆãˆã‚‹/é…ã‚Œã‚‹ âš¡
    Note left of ã‚¢ãƒ—ãƒª: 4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼å¤±æ•—ã¨åˆ¤æ–­ âŒ
    ã‚¢ãƒ—ãƒª->>ã‚¢ãƒ—ãƒª: 5. æ³¨æ–‡ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    Note over ã‚¢ãƒ—ãƒª, æ±ºæ¸ˆAPI: çµæœ: æ³¨æ–‡ã¯ãªã„ã®ã«èª²é‡‘ã ã‘æˆåŠŸã—ã¦ã„ã‚‹çŠ¶æ…‹ ğŸ˜±
```

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼šã€Œã“ã£ã¡ã¯æˆåŠŸã—ãŸã®ã«ã€ç›¸æ‰‹ã¯å¤±æ•—ã—ã¦ã‚‹ã€ğŸ˜µâ€ğŸ’«ğŸ“¨

é€†ã‚‚ã‚ã‚‹ã‚ˆï¼

* ã‚ãªãŸï¼šã€Œæ±ºæ¸ˆOKã£ã¦ã“ã¨ã§æ³¨æ–‡ã‚’ç¢ºå®šï¼âœ…ã€
* å®Ÿã¯æ±ºæ¸ˆå´ã¯å¤±æ•—ï¼ˆã‚ã‚‹ã„ã¯å‡¦ç†ã§ãã¦ãªã„ï¼‰âŒ

çµæœğŸ‘‡
**æ³¨æ–‡ã¯ç¢ºå®šã—ã¦ã‚‹ã®ã«ã€æ±ºæ¸ˆã¯å–ã‚Œã¦ãªã„**ğŸ˜‡

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³Cï¼šã€ŒDBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹ã„ãŸã¾ã¾å¤–éƒ¨I/Oå¾…ã¡ã€ã§è©°ã‚€ğŸ§ŠğŸ”’

ã‚„ã‚ŠãŒã¡ãªåœ°é›·ğŸ‘‡

1. DBã§ `BEGIN`ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
2. æ³¨æ–‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä»®ä½œæˆ
3. æ±ºæ¸ˆAPIã‚’å‘¼ã¶ï¼ˆã“ã“ã§é…ã„ãƒ»æ­¢ã¾ã‚‹ãƒ»è©°ã¾ã‚‹ï¼‰ğŸ¢ğŸ’¤
4. ãã®é–“ãšãƒ¼ãƒ¼ã£ã¨DBã®ãƒ­ãƒƒã‚¯ãŒæ®‹ã‚‹ğŸ”’

çµæœğŸ‘‡

* ã»ã‹ã®æ³¨æ–‡å‡¦ç†ãŒãƒ­ãƒƒã‚¯å¾…ã¡ã§æ¸‹æ»ğŸš—ğŸš—ğŸš—
* ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆé€£é–ã§éšœå®³ã£ã½ããªã‚‹ğŸ’¥

ã¤ã¾ã‚Šã€Œå®‰å…¨ãã†ã«è¦‹ãˆã‚‹ã‹ã‚‰ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§åŒ…ã‚€ã€ã¯ã€**å¯ç”¨æ€§ã‚’è½ã¨ã™æ–¹å‘ã«åƒããŒã¡**ãªã®ğŸ˜¢

```mermaid
flowchart TD
    subgraph App ["ã‚¢ãƒ—ãƒªã®å‡¦ç†"]
    A[BEGIN] --> B[æ³¨æ–‡ä½œæˆ]
    B --> C[æ±ºæ¸ˆAPIå‘¼å‡º ğŸ¢ğŸ’¤]
    C --> D[COMMIT]
    end
    subgraph DB ["ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"]
    Lock[æ³¨æ–‡è¡Œ/ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ­ãƒƒã‚¯ ğŸ”’]
    end
    B -. lock .-> Lock
    Lock -. unlock .-> D
    Other[ä»–ã®æ³¨æ–‡] -- å¾…ã¡è¡Œåˆ— --x Lock
    style C fill:#ffebee,stroke:#c62828
```

---

## ãƒ‘ã‚¿ãƒ¼ãƒ³Dï¼šã€Œãƒªãƒˆãƒ©ã‚¤ï¼å†é€ã€ã§äºŒé‡å®Ÿè¡ŒğŸ‘»ğŸ”

åˆ†æ•£ã®ä¸–ç•Œã¯ã€Œ1å›é€ã£ãŸã¤ã‚‚ã‚Šã€ãŒä¿¡ç”¨ã§ããªã„ã‹ã‚‰ã€ã ã„ãŸã„**ãƒªãƒˆãƒ©ã‚¤**ã™ã‚‹è¨­è¨ˆã«ãªã‚‹ã‚ˆã­ğŸ”

ã§ã‚‚ã€ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã¨â€¦

* æ±ºæ¸ˆãŒ2å›èµ°ã‚‹ï¼ˆäºŒé‡èª²é‡‘ï¼‰ğŸ’³ğŸ’³ğŸ˜±
* ç™ºé€ãŒ2å›èµ°ã‚‹ï¼ˆäºŒé‡é…é€ï¼‰ğŸ“¦ğŸ“¦ğŸ˜±

ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã§ã‚‚ã€Œé‡è¤‡é…ä¿¡ã¯èµ·ãã†ã‚‹ï¼ˆå°‘ãªãã¨ã‚‚1å›ï¼‰ã€å‰æã§ä½œã‚Œã€ã£ã¦ã„ã†ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ãŒæ™®é€šã«å‡ºã¦ã‚‹ã‚ˆğŸ“Œ
ã ã‹ã‚‰**å†ªç­‰æ€§ï¼ˆåŒã˜å‡¦ç†ã‚’è¤‡æ•°å›ã‚„ã£ã¦ã‚‚çµæœãŒ1å›ã¨åŒã˜ï¼‰**ãŒå¿…é ˆã«ãªã‚‹ã®ğŸ˜Š ([Microsoft Learn][2])

---

# 3-4. ã€Œåˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ2PCï¼‰ã§å…¨éƒ¨ã¾ã¨ã‚ã‚Œã°ã„ã„ã˜ã‚ƒã‚“ï¼Ÿã€ã¯ã€ãªãœä¸‡èƒ½ã˜ã‚ƒãªã„ï¼Ÿâš–ï¸ğŸ¢

ã€Œã˜ã‚ƒã‚2PCï¼ˆTwo-Phase Commitï¼‰ã§ã€åˆ†æ•£ã§ã‚‚â€œå…¨éƒ¨æˆåŠŸã‹å…¨éƒ¨å¤±æ•—â€ã‚’ä½œã‚Œã°ã‚ˆããªã„ï¼Ÿã€
â€¦ã£ã¦ç™ºæƒ³ã¯è‡ªç„¶ãªã‚“ã ã‘ã©ã€ç¾å®Ÿã¯ã¤ã‚‰ã„ğŸ¥²

2PCã¯å¼·ã„ä¸€è²«æ€§ã‚’ç‹™ãˆã‚‹ä¸€æ–¹ã§ã€

* **ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ã‚„ã™ã„ï¼ˆå¾…ã¡çŠ¶æ…‹ãŒç™ºç”Ÿï¼‰**
* **ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãŒæ­»ã¬ã¨å‚åŠ è€…ãŒæ±ºã‚ã‚‰ã‚Œãšæ­¢ã¾ã‚Šã‚„ã™ã„**

ã¿ãŸã„ãªå¼±ç‚¹ãŒâ€œå®šç•ªã®æ¬ ç‚¹â€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã‚‹ã‚ˆğŸ“Œ ([ã‚¦ã‚£ã‚­ãƒšãƒ‡ã‚£ã‚¢][3])

ã•ã‚‰ã«ã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã¯ã€Œãƒãƒ¼ãƒ‰ã‚‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚‚ä¿¡é ¼ã§ããªã„ãƒ»é…å»¶ãŒã‚ã‚‹ã€å‰æã§è¨­è¨ˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€ã¨ã„ã†è©±ãŒç¹°ã‚Šè¿”ã—èªã‚‰ã‚Œã¦ã‚‹ï¼ˆï¼æ¥½è¦³ã§ããªã„ï¼‰ğŸ˜µâ€ğŸ’« ([martinfowler.com][4])

ã ã‹ã‚‰ã€å®Ÿå‹™ã§ã¯ã€Œ2PCã§å…¨ä½“ã‚’ã‚¬ãƒã‚¬ãƒã«ç¸›ã‚‹ã€ã‚ˆã‚Šã‚‚ã€**Sagaã¿ãŸã„ãªâ€œæˆ»ã—æ–¹ã‚’ç”¨æ„ã—ã¦å‰ã«é€²ã‚€â€**ãŒé¸ã°ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‚“ã ã‚ˆã­ğŸš€

![2PC vs Saga Failure](./picture/saga_ts_study_003_2pc_issues.png)

---

# 3-5. ã“ã®ç« ã®çµè«–ï¼ˆè¶…é‡è¦ï¼‰ğŸ”‘âœ¨

## âœ… â€œå…¨éƒ¨ã¾ã¨ã‚ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³â€ãŒé›£ã—ã„ç†ç”±ã¾ã¨ã‚

* å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¯ **åŒã˜DBã®ãƒ­ãƒƒã‚¯ã‚„åˆ¶ç´„ã®æ”¯é…ä¸‹ã«ã„ãªã„** ğŸ§©
* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é…å»¶ãƒ»åˆ‡æ–­ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã€**æˆåŠŸ/å¤±æ•—ã®èªè­˜ãŒã‚ºãƒ¬ã‚‹** ğŸ“¡
* ãƒªãƒˆãƒ©ã‚¤ã‚„å†é€ã§ã€**é‡è¤‡å®Ÿè¡ŒãŒèµ·ãã‚‹** ğŸ”ğŸ‘»
* é•·ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒ­ãƒƒã‚¯ã‚’é•·å¼•ã‹ã›ã¦ã€**å…¨ä½“ã®å¯ç”¨æ€§ã‚’è½ã¨ã—ã‚„ã™ã„** ğŸ”’ğŸ§Š

ã“ã®ã€Œã‚ºãƒ¬ã€ã¨ã€Œéƒ¨åˆ†æˆåŠŸã€ã‚’ã€ã¡ã‚ƒã‚“ã¨ç¾å®Ÿã¨ã—ã¦å—ã‘æ­¢ã‚ã¦è¨­è¨ˆã™ã‚‹ã®ãŒSagaã®å‡ºç•ªã ã‚ˆğŸ§¯âœ¨

---

# 3-6. ä½“é¨“ãƒŸãƒ‹ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã€ŒæˆåŠŸãªã®ã«å¤±æ•—æ‰±ã„ã€ã‚’å†ç¾ğŸ˜ˆâ°

ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ±ºæ¸ˆãŒâ€œãŸã¾ã«é…ã„â€ä¸–ç•Œã‚’å†ç¾ã™ã‚‹ã‚ˆğŸ¢
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‚‰ã€Œå¤±æ•—ï¼ã€ã£ã¦è¦‹ãˆã‚‹ã®ã«ã€**é…ã‚Œã¦æˆåŠŸã—ã¦ã‚‹ã‹ã‚‚**ãŒèµ·ãã‚‹ğŸ˜±

```ts
// chapter3-timeout-demo.ts
const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));

type PaymentResult = { paymentId: string };

// ãŸã¾ã«é…ã„ï¼ˆã§ã‚‚æœ€çµ‚çš„ã«ã¯æˆåŠŸã™ã‚‹ï¼‰æ±ºæ¸ˆAPIã®ã¤ã‚‚ã‚Š
async function fakePaymentApi(orderId: string): Promise<PaymentResult> {
  const latency = 200 + Math.floor(Math.random() * 2000); // 200ã€œ2200ms
  await sleep(latency);
  return { paymentId: `pay_${orderId}_${Date.now()}` };
}

async function withTimeout<T>(p: Promise<T>, ms: number): Promise<T> {
  return await Promise.race([
    p,
    (async () => {
      await sleep(ms);
      throw new Error(`TIMEOUT after ${ms}ms`);
    })(),
  ]);
}

async function placeOrder(orderId: string) {
  console.log(`ğŸ›’ order start: ${orderId}`);

  // ã“ã“ã§ã€ŒDBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ã€ã¿ãŸã„ãªæ°—æŒã¡ã«ãªã‚‹ã‘ã©â€¦
  // å®Ÿéš›ã«å¤–éƒ¨I/Oã‚’æŒŸã‚€ã¨äº‹æ•…ã‚Šã‚„ã™ã„
  try {
    const payment = await withTimeout(fakePaymentApi(orderId), 700);
    console.log(`âœ… payment success:`, payment);

    console.log(`âœ… order confirmed: ${orderId}`);
  } catch (e) {
    console.log(`âŒ order failed (seen by us): ${orderId}`, e);
    console.log(`ğŸ§¯ (maybe) rollback order in DB...`);
  }
}

(async () => {
  for (let i = 1; i <= 5; i++) {
    await placeOrder(`order${i}`);
    console.log("----");
  }
})();
```

## è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆğŸ‘€âœ¨

* âŒ ãŒå‡ºãŸã‚±ãƒ¼ã‚¹ã§ã‚‚ã€å®Ÿã¯ `fakePaymentApi` ã¯è£ã§æˆåŠŸã—ã¦ã‚‹ã‹ã‚‚â€¦ã£ã¦æ°—æŒã¡ã«ãªã‚‹ã¯ãšğŸ˜‡
* ç¾å®Ÿã®æ±ºæ¸ˆAPIã ã¨ã€**ã€Œèª²é‡‘ã•ã‚ŒãŸã‹ï¼Ÿã€ã‚’ç…§ä¼šã™ã‚‹æ‰‹æ®µ**ã‚„ã€**å†ªç­‰ã‚­ãƒ¼**ãŒç”¨æ„ã•ã‚Œã¦ã‚‹ã“ã¨ãŒå¤šã„ï¼ˆã˜ã‚ƒãªã„ã¨é‹ç”¨ã§ããªã„ï¼‰ğŸ’¡
* ã ã‹ã‚‰æ¬¡ç« ä»¥é™ã§ã€Œæˆ»ã—æ–¹ã€ã€ŒçŠ¶æ…‹ã€ã€Œå†ªç­‰æ€§ã€ãŒä¸»å½¹ã«ãªã‚‹ã‚ˆğŸ”‘

---

# 3-7. ãƒŸãƒ‹æ¼”ç¿’ğŸ“ğŸ’ï¼ˆãƒãƒ¼ãƒˆã«æ‰‹æ›¸ãã§OKï¼‰

é¡Œæï¼šæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«ç¢ºä¿â†’ç™ºé€ğŸ“¦

## Q1 ğŸ¤”

ã€Œã©ã“ãŒDBå†…ã€ã€Œã©ã“ãŒå¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã€ã‹åˆ†ã‘ã¦ã¿ã‚ˆã†âœ‚ï¸

* DBå†…ï¼š
* å¤–éƒ¨ï¼š

## Q2 ğŸ˜ˆ

æ¬¡ã®å¤±æ•—ãŒèµ·ããŸã¨ãã€ä½•ãŒã‚ºãƒ¬ã‚‹ï¼Ÿã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ğŸ‘‡

* æ±ºæ¸ˆæˆåŠŸã—ãŸã®ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
* åœ¨åº«ç¢ºä¿æˆåŠŸã—ãŸã®ã«è¿”äº‹ãŒæ¥ãªã„
* ç™ºé€ä¾é ¼ãŒäºŒé‡ã«é€ã‚‰ã‚ŒãŸ

## Q3 ğŸ§¯

ã€Œæˆ»ã—æ–¹ï¼ˆè£œå„Ÿï¼‰ã€ã‚’1ã¤ãšã¤è€ƒãˆã¦ã¿ã‚ˆã†âœ¨

* æ±ºæ¸ˆã®è£œå„Ÿï¼š
* åœ¨åº«ã®è£œå„Ÿï¼š
* ç™ºé€ã®è£œå„Ÿï¼š

---

# 3-8. AIæ´»ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ğŸ¤–ğŸ’¬ï¼ˆãã®ã¾ã¾è²¼ã£ã¦OKï¼‰

## â‘  å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ´—ã„å‡ºã—

* ã€Œæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«â†’ç™ºé€ã®ãƒ•ãƒ­ãƒ¼ã§ã€åˆ†æ•£ã§èµ·ãã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ã—ã¦ã€‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€é‡è¤‡å®Ÿè¡Œã€éƒ¨åˆ†æˆåŠŸã€é…å»¶æˆåŠŸã€å†é€ã‚‚å…¥ã‚Œã¦ã€‚ã€

## â‘¡ â€œäº‹æ•…ã‚‹ã‚³ãƒ¼ãƒ‰â€ã‚’ä½œã‚‰ã›ã‚‹ï¼ˆå­¦ç¿’ã«ã‚ã¡ã‚ƒåŠ¹ãğŸ˜ˆï¼‰

* ã€ŒTypeScriptã§ã€å¤–éƒ¨APIå‘¼ã³å‡ºã—ãŒé…å»¶ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»é‡è¤‡æˆåŠŸã™ã‚‹ãƒ‡ãƒ¢ã‚³ãƒ¼ãƒ‰ã‚’ä½œã£ã¦ã€‚ãƒ­ã‚°ã§çŠ¶æ³ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã€‚ã€

## â‘¢ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿‚ã«ã™ã‚‹âœ…

* ã€Œã“ã®å®Ÿè£…ã®â€œäºŒé‡å®Ÿè¡Œãƒªã‚¹ã‚¯â€ã¨â€œæ•´åˆæ€§ã‚ºãƒ¬â€ã®ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡æ‘˜ã—ã¦ã€‚æ”¹å–„æ¡ˆã‚’3æ®µéšï¼ˆè»½ã„/æ™®é€š/æœ¬æ°—ï¼‰ã§ã€‚ã€

---

# 3-9. ã“ã®ç« ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…âœ¨

* [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ã€Œå¤±æ•—ã—ãŸã€ã¨ã¯é™ã‚‰ãªã„ã€ã¨è¨€ãˆã‚‹ğŸ˜µâ€ğŸ’«â°
* [ ] â€œéƒ¨åˆ†æˆåŠŸâ€ãŒèµ·ãã‚‹ç†ç”±ã‚’ã€1ã¤ã®ä¾‹ã§èª¬æ˜ã§ãã‚‹ğŸ§©
* [ ] ãƒªãƒˆãƒ©ã‚¤ãŒäºŒé‡å®Ÿè¡Œã‚’ç”Ÿã‚€ã“ã¨ã‚’ç†è§£ã—ãŸğŸ‘»ğŸ”
* [ ] ã€Œã ã‹ã‚‰SagaãŒå¿…è¦ãªã‚“ã ã€ãŒè…¹è½ã¡ã—ãŸğŸ§¯âœ¨

[1]: https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing?utm_source=chatgpt.com "Fallacies of distributed computing"
[2]: https://learn.microsoft.com/en-us/azure/architecture/serverless/event-hubs-functions/resilient-design?utm_source=chatgpt.com "Resilient design guidance for Event Hubs and Functions"
[3]: https://en.wikipedia.org/wiki/Two-phase_commit_protocol?utm_source=chatgpt.com "Two-phase commit protocol"
[4]: https://martinfowler.com/articles/patterns-of-distributed-systems/?utm_source=chatgpt.com "Catalog of Patterns of Distributed Systems"
