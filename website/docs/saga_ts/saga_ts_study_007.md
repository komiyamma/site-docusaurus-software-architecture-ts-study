# ç¬¬7ç« ï¼šè¨­è¨ˆå…¥é–€â‘¡ â€œè²¬å‹™â€ã£ã¦ãªã«ï¼Ÿï¼ˆè–„ã„å±¤ã®æ„è­˜ï¼‰ğŸ§ğŸ“š

## ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* ã€Œã“ã®å‡¦ç†ã€ã©ã“ã«æ›¸ã‘ã°ã„ã„ã®ï¼Ÿã€ã§è¿·ã†å›æ•°ã‚’æ¸›ã‚‰ã™ğŸ§­ğŸ’¡
* Controller / Service / Repository ã®â€œå½¹å‰²åˆ†æ‹…â€ã‚’ã€ã‚µãƒƒã¨èª¬æ˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ’¬
* Sagaã‚’ä½œã‚‹ã¨ãã«ã€ã‚³ãƒ¼ãƒ‰ãŒã‚´ãƒãƒ£ãƒƒã¨æ··ã–ã‚‹ã®ã‚’é˜²ãğŸ§¯ğŸ§©

---

# 1) â€œè²¬å‹™â€ã£ã¦ãªã«ï¼ŸğŸ¤”ğŸ§©

**è²¬å‹™ = ãã®éƒ¨å“ãŒå¼•ãå—ã‘ã‚‹ä»•äº‹ã®ç¯„å›²ï¼ˆæ‹…å½“ç¯„å›²ï¼‰**ã ã‚ˆğŸ˜Šâœ¨

ãŸã¨ãˆã°ã€Œæ³¨æ–‡ã‚’ä½œã‚‹ã€ã£ã¦ä¸€è¨€ã§ã‚‚ã€å®Ÿã¯ä¸­èº«ãŒã„ã‚ã„ã‚ã‚ã‚‹ã®ğŸ‘‡

* HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹ğŸ“©
* å…¥åŠ›ãƒã‚§ãƒƒã‚¯ã™ã‚‹âœ…
* ã©ã‚“ãªé †ç•ªã§å‡¦ç†ã™ã‚‹ã‹æ±ºã‚ã‚‹ï¼ˆãƒ“ã‚¸ãƒã‚¹æ‰‹é †ï¼‰ğŸ§ 
* DBã«ä¿å­˜ã™ã‚‹ğŸ—„ï¸
* ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚‰ã©ã†è¿”ã™ã‹æ±ºã‚ã‚‹âš ï¸
* ãƒ­ã‚°ã‚„è¿½è·¡IDã‚’ä»˜ã‘ã‚‹ğŸ”

ã“ã®å…¨éƒ¨ã‚’1ã¤ã®é–¢æ•°ã«è©°ã‚è¾¼ã‚€ã¨ã€ã™ãã«â€œè¿·å­ã‚³ãƒ¼ãƒ‰â€ã«ãªã‚‹ğŸ˜µâ€ğŸ’«ğŸ’¦
ã ã‹ã‚‰ **ã€Œè²¬å‹™ã‚’åˆ†ã‘ã‚‹ã€**ã®ãŒè¨­è¨ˆã®æœ€åˆã®ä¸€æ­©ã ã‚ˆğŸš¶â€â™€ï¸ğŸŒ±

---

# 2) â€œè–„ã„å±¤â€ã£ã¦ã©ã†ã„ã†æ°—æŒã¡ï¼ŸğŸ§

ã€Œè–„ã„å±¤ã€ã£ã¦ã„ã†ã®ã¯ã€ã–ã£ãã‚Šè¨€ã†ã¨ğŸ‘‡

* **å„å±¤ã¯â€œã‚„ã‚‹ã“ã¨ã‚’å°‘ãªãâ€**ã—ã¦ã€åˆ¤æ–­ã‚’åˆ†æ•£ã—ãªã„
* **ä¸Šã®å±¤ã¯ä¸‹ã®å±¤ã‚’ä½¿ã†ã ã‘**ï¼ˆä¸‹ã®å±¤ã®äº‹æƒ…ã«è¸ã¿è¾¼ã¾ãªã„ï¼‰
* ãã‚Œãã‚ŒãŒâ€œè‡ªåˆ†ã®ä»•äº‹ã ã‘â€ã‚’ã—ã¦ã€ä»–äººã®ä»•äº‹ã‚’å¥ªã‚ãªã„ğŸ™…â€â™€ï¸

ã“ã‚Œã‚’ã‚„ã‚‹ã¨å¬‰ã—ã„ã“ã¨ãŒã„ã£ã±ã„ğŸ˜ŠğŸ’•

* ä¿®æ­£ãŒå±€æ‰€ã§æ¸ˆã‚€ğŸ”§
* ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„ğŸ§ª
* è¿½åŠ æ©Ÿèƒ½ã§ç ´å£Šã—ã«ãã„ğŸ›¡ï¸
* ã€Œã“ã“è¦‹ã‚Œã°ã„ã„ã€ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ğŸ—ºï¸

---

# 3) ã¾ãšã¯ç‹é“ï¼šController / Service / Repository ğŸ‘‘

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¶…ã‚ˆãã‚ã‚‹åˆ†ã‘æ–¹ãŒã“ã®3ã¤ã ã‚ˆğŸ‘‡
ï¼ˆNestJSã¿ãŸã„ãªTypeScriptå‘ã‘ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚‚ã€Controller ã¨ Serviceï¼ˆProviderï¼‰ä¸­å¿ƒã§çµ„ã¿ç«‹ã¦ã‚‹è€ƒãˆæ–¹ãŒåŸºæœ¬ã«ã‚ã‚‹ã‚ˆğŸ˜Šï¼‰ ([NestJS Docs][1])

## Controllerï¼ˆå…¥å£ï¼‰ğŸšªğŸ“©

**ã‚„ã‚‹ã“ã¨ï¼šå¤–ã‹ã‚‰æ¥ãŸã‚‚ã®ã‚’å—ã‘å–ã£ã¦ã€è¿”ã™**

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ•´å½¢
* å…¥åŠ›ã®è»½ã„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
* èªå¯/èªè¨¼ã®â€œå…¥ã‚Šå£â€ï¼ˆè©³ç´°ã¯åˆ¥éƒ¨å“ã«ä»»ã›ãŒã¡ï¼‰
* Serviceã‚’å‘¼ã¶ã ã‘ï¼ˆã“ã“ãŒå¤§äº‹ï¼ï¼‰âœ¨

âœ… åˆè¨€è‘‰ï¼š**Controllerã¯è–„ãï¼**ï¼ˆãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ã‚’ç½®ã‹ãªã„ï¼‰ ([GitHub][2])

```mermaid
graph TD
    Client[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] -- Request --> Controller[Controller]
    Controller -- calls --> Service[Service]
    Service -- calls --> Repository[Repository]
    Repository -- SQL --> DB[(DB)]
    
    style Controller fill:#e1f5fe,stroke:#01579b
    style Service fill:#fff9c4,stroke:#fbc02d
    style Repository fill:#e8f5e9,stroke:#2e7d32
```

---

## Serviceï¼ˆæ‰‹é †ãƒ»åˆ¤æ–­ã®ä¸­å¿ƒï¼‰ğŸ§ ğŸ§‘â€ğŸ³

**ã‚„ã‚‹ã“ã¨ï¼šãƒ“ã‚¸ãƒã‚¹ã®æ‰‹é †ã‚’çµ„ã¿ç«‹ã¦ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰**

* ã€Œæ³¨æ–‡â†’æ±ºæ¸ˆâ†’åœ¨åº«â†’ç™ºé€ã€ã¿ãŸã„ãªæµã‚Œã‚’æ±ºã‚ã‚‹
* â€œã©ã“ã¾ã§æˆåŠŸã—ãŸï¼Ÿâ€ã‚’è¦‹ã¦æ¬¡ã‚’æ±ºã‚ã‚‹
* ã‚¨ãƒ©ãƒ¼ã®æ‰±ã„ï¼ˆãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ï¼Ÿè£œå„Ÿã™ã‚‹ï¼Ÿï¼‰ã®åˆ¤æ–­
* ã„ã‚ã‚“ãªRepositoryã‚„å¤–éƒ¨I/Oéƒ¨å“ã‚’çµ„ã¿åˆã‚ã›ã‚‹

âœ… åˆè¨€è‘‰ï¼š**æ‰‹é †ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰ã¯Serviceã¸ï¼** ([GitHub][2])

---

## Repositoryï¼ˆä¿å­˜ã¨å–å¾—ï¼‰ğŸ—„ï¸ğŸ“¦

**ã‚„ã‚‹ã“ã¨ï¼šãƒ‡ãƒ¼ã‚¿ã®å‡ºã—å…¥ã‚Œï¼ˆæ°¸ç¶šåŒ–ï¼‰**

* DBã‹ã‚‰å–ã‚‹
* DBã«ä¿å­˜ã™ã‚‹
* ã§ãã‚Œã°â€œãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­â€ã¯å…¥ã‚Œãªã„ï¼ˆå…¥ã‚Œã‚‹ã¨åœ°ç„ï¼‰ğŸ˜‡ğŸ’¦
* ORMã‚„SQLã®éƒ½åˆã‚’ã“ã“ã«é–‰ã˜è¾¼ã‚ã‚‹

ã€ŒRepositoryãƒ‘ã‚¿ãƒ¼ãƒ³ã§DB/ORMã¸ã®ä¾å­˜ã‚’è–„ãã™ã‚‹ã€è€ƒãˆæ–¹ã¯ã€NestJSç•Œéšˆã§ã‚‚ã‚ˆãèªã‚‰ã‚Œã‚‹ã‚ˆğŸ§© ([Medium][3])

âœ… åˆè¨€è‘‰ï¼š**Repositoryã¯ãƒ‡ãƒ¼ã‚¿ä¿‚ï¼** ğŸ“š

![Layered Architecture](./picture/saga_ts_study_007_layers.png)

---

# 4) Sagaã¨â€œè²¬å‹™â€ã®ç›¸æ€§ğŸ±âœ¨ï¼ˆæ··ã–ã‚Šã‚„ã™ã„ãƒã‚¤ãƒ³ãƒˆæ³¨æ„ï¼ï¼‰

Sagaã£ã¦ã€Œè¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®æ‰‹é †ï¼‹å¤±æ•—æ™‚ã®æˆ»ã—ã€ã ã‹ã‚‰ã€æ”¾ã£ã¦ãŠãã¨å…¨éƒ¨ãŒæ··ã–ã‚Šã‚„ã™ã„ğŸ˜µâ€ğŸ’«ğŸ’¦

ã ã‹ã‚‰ã€è²¬å‹™ã‚’ã“ã†å‰²ã‚‹ã¨ã‚¹ãƒƒã‚­ãƒªã—ã‚„ã™ã„ã‚ˆğŸ‘‡

* **Controller**ï¼šSagaé–‹å§‹ã®å…¥å£ï¼ˆä¾‹ï¼šPOST /ordersï¼‰
* **Serviceï¼ˆã¾ãŸã¯ Orchestratorï¼‰**ï¼šSagaã®æ‰‹é †ã®å¸ä»¤å¡”ï¼ˆæ¬¡ã®Stepã¯ä½•ï¼Ÿå¤±æ•—ãªã‚‰è£œå„Ÿï¼Ÿï¼‰ğŸ»
* **Repository**ï¼š

  * æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
  * SagaçŠ¶æ…‹ï¼ˆé€²æ—ï¼‰ã®ä¿å­˜ï¼ˆã©ã“ã¾ã§æˆåŠŸã—ãŸã‹ï¼‰
  * â€œå®Ÿè¡Œæ¸ˆã¿â€ãªã©ã®è¨˜éŒ²

ã€Œå±¤ã‚’åˆ†ã‘ã¦ã€Webå±¤ãŒå‹æ‰‹ã«ä¸‹å±¤ã¸ä¾µå…¥ã—ãªã„ã€ã¿ãŸã„ãªè¨­è¨ˆæŒ‡é‡ã¯ã€Nodeã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã‚‚å¼·èª¿ã•ã‚ŒãŒã¡ã ã‚ˆğŸ”’ ([GitHub][2])

```mermaid
graph LR
    subgraph Saga_Layers ["Sagaã®è²¬å‹™ã¨å±¤ã®å¯¾å¿œ"]
        BC[POST /orders] --> Layer1[Controller]
        Step[æ‰‹é †ã®å®Ÿè¡Œ/è£œå„Ÿåˆ¤æ–­] --> Layer2[Service / Orchestrator]
        State[é€²æ—ãƒ»çŠ¶æ…‹ã®ä¿å­˜] --> Layer3[Repository]
    end
```

---

# 5) è¿·ã£ãŸã¨ãã®â€œç½®ãå ´æ‰€ãƒ«ãƒ¼ãƒ«â€ğŸ§­âœ¨

ã€Œã©ã“ã«æ›¸ãã¹ãï¼Ÿã€ã£ã¦ãªã£ãŸã‚‰ã€ã“ã®è³ªå•ã‚’é †ç•ªã«ã—ã¦ã­ğŸ˜Š

## Q1: ã“ã‚Œã¯HTTPã®è©±ï¼Ÿãã‚Œã¨ã‚‚ãƒ“ã‚¸ãƒã‚¹ã®è©±ï¼ŸğŸŒ

* HTTPã®è©±ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€req/resæ•´å½¢ï¼‰ â†’ **Controller**
* ãƒ“ã‚¸ãƒã‚¹ã®è©±ï¼ˆæ³¨æ–‡ã§ãã‚‹æ¡ä»¶ã€å®Ÿè¡Œé †ã€è£œå„Ÿåˆ¤æ–­ï¼‰ â†’ **Service**

## Q2: ã“ã‚Œã¯DB/ä¿å­˜ã®è©±ï¼ŸğŸ—„ï¸

* SQL/ORM/ä¿å­˜å½¢å¼ãŒçµ¡ã‚€ â†’ **Repository**

## Q3: â€œæ‰‹é †â€ãªã®ï¼Ÿâ€œéƒ¨å“â€ãªã®ï¼ŸğŸ§©

* æ‰‹é †ï¼ˆAã—ã¦Bã—ã¦Cã—ã¦â€¦ï¼‰ â†’ **Service**
* éƒ¨å“ï¼ˆä¿å­˜ã™ã‚‹ã€é€ã‚‹ã€å‘¼ã¶ï¼‰ â†’ **Repository**ã‚„å¤–éƒ¨I/Oç”¨ã®ã‚¯ãƒ©ã‚¹

---

# 6) ãƒŸãƒ‹ä¾‹ï¼šæ³¨æ–‡Sagaã®â€œè–„ã„å±¤â€ã‚µãƒ³ãƒ—ãƒ«ğŸ›’ğŸ§¯

## 6-1. ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚¤ãƒ¡ãƒ¼ã‚¸ğŸ“âœ¨

* `order.controller.ts`ï¼ˆå…¥å£ï¼‰
* `order.service.ts`ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰
* `order.repository.ts`ï¼ˆDBï¼‰
* `orderSaga.orchestrator.ts`ï¼ˆSagaå¸ä»¤å¡”ï¼šServiceã«å«ã‚ã¦ã‚‚OKï¼‰

ã€Œå±¤ã§åˆ†ã‘ã‚‹ or æ©Ÿèƒ½ï¼ˆfeatureï¼‰ã§åˆ†ã‘ã‚‹ã€ã¯ã€è¿‘å¹´ã®Node/TSã§ã‚‚å®šç•ªã®æ•´ç†è»¸ã¨ã—ã¦ã‚ˆãå‡ºã‚‹ã‚ˆğŸ“¦ ([DEV Community][4])

---

## 6-2. Controllerã¯â€œè–„ãâ€âœ¨ï¼ˆServiceã‚’å‘¼ã¶ã ã‘ï¼‰

```ts
// order.controller.ts
import { OrderService } from "./order.service";

export class OrderController {
  constructor(private readonly orderService: OrderService) {}

  async createOrder(reqBody: { userId: string; items: Array<{ sku: string; qty: number }> }) {
    // âœ… å…¥å£ã®è»½ã„ãƒã‚§ãƒƒã‚¯ï¼ˆé‡ã™ããªã„ï¼‰
    if (!reqBody.userId) throw new Error("userId is required");
    if (!reqBody.items?.length) throw new Error("items is required");

    // âœ… ãƒ“ã‚¸ãƒã‚¹ã®æ‰‹é †ã¯Serviceã¸
    const result = await this.orderService.startOrderSaga(reqBody);

    // âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ï¼ˆã“ã“ã¯Controllerã®ä»•äº‹ï¼‰
    return { orderId: result.orderId, sagaId: result.sagaId };
  }
}
```

---

## 6-3. ServiceãŒâ€œæ‰‹é †â€ã‚’æŒã¤ğŸ§ ğŸ»

```ts
// order.service.ts
import { OrderRepository } from "./order.repository";
import { OrderSagaOrchestrator } from "./orderSaga.orchestrator";

export class OrderService {
  constructor(
    private readonly orderRepo: OrderRepository,
    private readonly saga: OrderSagaOrchestrator
  ) {}

  async startOrderSaga(input: { userId: string; items: Array<{ sku: string; qty: number }> }) {
    // âœ… ã“ã“ã‹ã‚‰ã¯ã€Œæ³¨æ–‡ã‚’æˆç«‹ã•ã›ã‚‹ãŸã‚ã®æ‰‹é †ã€
    // 1) æ³¨æ–‡ã‚’â€œä¸‹æ›¸ãâ€ã§ä½œã‚‹ï¼ˆãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ï¼‰
    const order = await this.orderRepo.createDraftOrder(input.userId, input.items);

    // 2) Sagaé–‹å§‹ï¼ˆæ‰‹é †ã®å¸ä»¤å¡”ã«ä»»ã›ã‚‹ï¼‰
    const sagaId = await this.saga.start({
      orderId: order.orderId,
      userId: input.userId,
      items: input.items,
    });

    return { orderId: order.orderId, sagaId };
  }
}
```

---

## 6-4. Repositoryã¯â€œãƒ‡ãƒ¼ã‚¿ä¿‚â€ğŸ—„ï¸ğŸ“¦

```ts
// order.repository.ts
type OrderRow = { orderId: string; userId: string; status: "DRAFT" | "CONFIRMED" | "CANCELLED" };

export class OrderRepository {
  // ã“ã“ã§ã¯DBæ¥ç¶šãªã©ã‚’æƒ³å®šï¼ˆçœç•¥ï¼‰
  async createDraftOrder(userId: string, items: Array<{ sku: string; qty: number }>) {
    // âœ… æ°¸ç¶šåŒ–ã®è©³ç´°ã¯ã“ã“ã«é–‰ã˜è¾¼ã‚ã‚‹
    const orderId = crypto.randomUUID();
    const row: OrderRow = { orderId, userId, status: "DRAFT" };

    // insert into orders ... (çœç•¥)
    // insert into order_items ... (çœç•¥)

    return row;
  }
}

```mermaid
sequenceDiagram
    participant User as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant C as Controller
    participant S as Service
    participant R as Repository
    participant DB as ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

    User->>C: POST /orders (reqBody)
    C->>S: startOrderSaga(input)
    S->>R: createDraftOrder(userId, items)
    R->>DB: INSERT order
    DB-->>R: OK
    R-->>S: orderRow
    Note over S: Sagaé–‹å§‹ (Orchestratorå‘¼ã³å‡ºã—)
    S-->>C: { orderId, sagaId }
    C-->>User: 201 Created
```
```

---

# 7) ã‚ã‚ŠãŒã¡äº‹æ•…ã‚ã‚‹ã‚ã‚‹ğŸ˜‡ğŸ’¥ï¼ˆãã—ã¦ç›´ã—æ–¹ï¼‰

## äº‹æ•…â‘ ï¼šControllerãŒå¤ªã‚‹ğŸ”ğŸ’¦

* Controllerã«ã€Œæ±ºæ¸ˆå¤±æ•—ãªã‚‰è¿”é‡‘ã—ã¦â€¦åœ¨åº«æˆ»ã—ã¦â€¦ã€ã¿ãŸã„ãªæ‰‹é †ãŒæ›¸ã‹ã‚Œã¦ã‚‹
  âœ… å¯¾ç­–ï¼š**æ‰‹é †ã¯Service/Sagaã¸ç§»å‹•ï¼**

## äº‹æ•…â‘¡ï¼šRepositoryã«ãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ãŒå…¥ã‚Šè¾¼ã‚€ğŸŒ€

* `if (order.total > 10000) discount...` ãŒRepositoryã«ã‚ã‚‹
  âœ… å¯¾ç­–ï¼š**åˆ¤æ–­ã¯Service/Domainã¸ï¼Repositoryã¯ä¿å­˜ã ã‘ï¼**

## äº‹æ•…â‘¢ï¼šServiceãŒHTTPã®éƒ½åˆã‚’æŒã¤ğŸ“®

* ServiceãŒ `res.status(400)` ã¨ã‹è¿”ã—å§‹ã‚ã‚‹
  âœ… å¯¾ç­–ï¼š**HTTPã¯Controllerã¸æˆ»ã™ï¼**

---

# 8) AIæ´»ç”¨ï¼šè¿·å­ã‚’æ¸›ã‚‰ã™â€œãŠé¡˜ã„ãƒ†ãƒ³ãƒ—ãƒ¬â€ğŸ¤–ğŸ’¬âœ¨

ã‚³ãƒ”ãƒšã§ä½¿ãˆã‚‹ã‚ˆã€œğŸ˜Š

* ã€Œã“ã®é–¢æ•°ã‚’ Controller / Service / Repository ã«åˆ†ã‘ã¦ã€è²¬å‹™ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ã—ã¦ã€
* ã€ŒControllerã¯è–„ãã€Serviceã«æ‰‹é †ã€Repositoryã«æ°¸ç¶šåŒ–ã€‚ãƒ«ãƒ¼ãƒ«é•åãŒã‚ã‚Œã°æŒ‡æ‘˜ã—ã¦ã€
* ã€ŒSagaã®Orchestratorã¨ã—ã¦å¦¥å½“ã‹ã€è²¬å‹™ã®å¢ƒç•ŒãŒå´©ã‚Œã¦ãªã„ã‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€

AIã¯é››å½¢ã¥ãã‚ŠãŒå¾—æ„ã ã‹ã‚‰ã€**â€œåˆ†ã‘æ¡ˆã‚’å‡ºã•ã›ã¦ã€äººé–“ãŒè²¬å‹™ãƒã‚§ãƒƒã‚¯ã™ã‚‹â€**ã®ãŒç›¸æ€§ã„ã„ã‚ˆâœ…ğŸ’•

---

# 9) ç« æœ«æ¼”ç¿’ï¼šæ³¨æ–‡å‡¦ç†ã®è²¬å‹™ã‚’3ã¤ã«åˆ†ã‘ã‚ˆã†ğŸ“âœ¨

## ãŠé¡ŒğŸ˜ˆ

æ¬¡ã®ã€Œå…¨éƒ¨å…¥ã‚Šé–¢æ•°ã€ã‚’ã€**Controller / Service / Repository**ã«åˆ†å‰²ã—ã¦ã­ï¼

```ts
async function createOrderEverything(reqBody: any) {
  // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
  if (!reqBody.userId) throw new Error("userId missing");

  // DBä¿å­˜
  const orderId = crypto.randomUUID();
  // insert into orders...

  // æ±ºæ¸ˆAPIå‘¼ã³å‡ºã—
  // charge...

  // åœ¨åº«ç¢ºä¿
  // reserve...

  // å¤±æ•—ã—ãŸã‚‰è¿”é‡‘ãƒ»åœ¨åº«æˆ»ã—
  // refund / release...

  return { orderId };
}
```

## ã‚„ã‚‹ã“ã¨âœ…

1. Controllerï¼šå…¥åŠ›ã‚’å—ã‘ã¦Serviceã‚’å‘¼ã¶ã ã‘ã«ã™ã‚‹ğŸšª
2. Serviceï¼šæ‰‹é †ï¼ˆSagaé–‹å§‹ï¼‰ã‚’æ›¸ãğŸ§ 
3. Repositoryï¼šæ³¨æ–‡ã®ä¿å­˜ã ã‘ã«ã™ã‚‹ğŸ—„ï¸

## ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆğŸ”

* Controllerã«â€œæ‰‹é †â€ãŒæ®‹ã£ã¦ãªã„ï¼Ÿ
* Repositoryã«â€œåˆ¤æ–­â€ãŒå…¥ã£ã¦ãªã„ï¼Ÿ
* Serviceã«â€œæ°¸ç¶šåŒ–ã®ç´°ã‹ã„SQLâ€ãŒå…¥ã£ã¦ãªã„ï¼Ÿ

ï¼ˆè§£ç­”ä¾‹ã¯ã€6ç« ã®ãƒŸãƒ‹ä¾‹ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚Œã°OKã ã‚ˆğŸ˜ŠğŸ«¶ï¼‰

---

# ã¾ã¨ã‚ğŸŒ¸

* **è²¬å‹™ = æ‹…å½“ç¯„å›²**ã€‚æ··ãœã‚‹ã¨è¿·å­ã«ãªã‚‹ğŸ˜µâ€ğŸ’«
* **Controllerã¯è–„ã**ã€**ServiceãŒæ‰‹é †**ã€**RepositoryãŒä¿å­˜**ğŸ§
* Sagaã¯æ··ã–ã‚Šã‚„ã™ã„ã‹ã‚‰ã€**å¸ä»¤å¡”ï¼ˆæ‰‹é †ï¼‰ã‚’Service/Orchestratorã«å¯„ã›ã‚‹**ã®ãŒã‚³ãƒ„ğŸ»
* è¿·ã£ãŸã‚‰ã€ŒHTTPï¼Ÿæ‰‹é †ï¼Ÿä¿å­˜ï¼Ÿã€ã§ä»•åˆ†ã‘ğŸ§­âœ¨

[1]: https://docs.nestjs.com/?utm_source=chatgpt.com "Documentation | NestJS - A progressive Node.js framework"
[2]: https://github.com/goldbergyoni/nodebestpractices?utm_source=chatgpt.com "The Node.js best practices list (July 2024)"
[3]: https://medium.com/%40mitchella0100/implementing-the-repository-pattern-in-nestjs-and-why-we-should-e32861df5457?utm_source=chatgpt.com "Implementing the Repository Pattern in NestJS (and why ..."
[4]: https://dev.to/pramod_boda/recommended-folder-structure-for-nodets-2025-39jl?utm_source=chatgpt.com "Recommended Folder Structure for Node(TS) 2025"
