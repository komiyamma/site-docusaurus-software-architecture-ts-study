# 35ç« ï¼šã‚¤ãƒ™ãƒ³ãƒˆã®é€²åŒ–ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ï¼‰ï¼‹å†ªç­‰æ€§ï¼ˆæœ€å°ï¼‰ğŸ§¬ğŸ§·

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«ğŸ¯

* ã‚¤ãƒ™ãƒ³ãƒˆãŒå°†æ¥ã€Œå¤‰æ›´ã—ãŸããªã£ãŸæ™‚ã€ã«ã€**å£Šã•ãšã«é€²åŒ–**ã•ã›ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‹ğŸ› ï¸
* ã€ŒåŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ2å›é£›ã‚“ã§ããŸğŸ˜±ã€ã§ã‚‚ **1å›åˆ†ã—ã‹å‡¦ç†ã—ãªã„**ï¼ˆå†ªç­‰æ€§ï¼‰ã‚’æœ€å°ã§å…¥ã‚Œã‚‰ã‚Œã‚‹ğŸ”âœ…
* â€œç¾å ´ã§ã‚ˆãã‚ã‚‹äº‹æ•…â€ã‚’é¿ã‘ã‚‹ **å®‰å…¨ãƒ«ãƒ¼ãƒ«**ãŒæŒã¡å¸°ã‚Œã‚‹ğŸš§âœ¨

---

## 1) ã¾ãšçµè«–ï¼šã‚¤ãƒ™ãƒ³ãƒˆã¯åŸºæœ¬ã€Œæ›¸ã„ãŸã‚‰å¤‰ãˆãªã„ã€ğŸ“œğŸ§Š

ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®ä¸–ç•Œã§ã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã¯ã€Œå±¥æ­´ã€ï¼**éå»ã®äº‹å®Ÿ**ã ã‹ã‚‰ã€å¾Œã‹ã‚‰æ›¸ãæ›ãˆã‚‹ã®ã¯åŸºæœ¬NGğŸ™…â€â™€ï¸
å¿…è¦ã«ãªã£ãŸã‚‰ã€æ¬¡ã®ã©ã‚Œã‹ã§é€²åŒ–ã•ã›ã‚‹ã®ãŒå®šç•ªã ã‚ˆâœ¨ ([event-driven.io][1])

* âœ… **è¶³ã™**ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã€optionalè¿½åŠ ï¼‰â€¦ã„ã¡ã°ã‚“å®‰å…¨ğŸ’š
* âœ… **æ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ **ï¼ˆåˆ¥ã®å‡ºæ¥äº‹ã¨ã—ã¦è¡¨ç¾ï¼‰â€¦æ„å‘³ãŒå¤‰ã‚ã‚‹ãªã‚‰ã“ã£ã¡
* âœ… **Upcastï¼ˆèª­ã¿å‡ºã—æ™‚å¤‰æ›ï¼‰**â€¦å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’â€œãã®å ´ã§â€æ–°ã—ã„å½¢ã«å¤‰æ›ã—ã¦èª­ã‚€ ([martendb.io][2])

---

## 2) ã€Œé€²åŒ–ã€ãŒå¿…è¦ã«ãªã‚‹ç¬é–“ã‚ã‚‹ã‚ã‚‹ğŸ˜ºğŸ’¥

ãŸã¨ãˆã°ã“ã‚“ãªå¤‰æ›´ã€ã„ã¤ã‹çµ¶å¯¾æ¥ã‚‹â€¦ï¼

* ğŸ§¾ ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã« `displayName` ã‚’è¿½åŠ ã—ãŸã„
* ğŸ’° é‡‘é¡ã« `currency` ã‚’è¿½åŠ ã—ãŸã„ï¼ˆJPYå›ºå®šã˜ã‚ƒãªããªã‚‹ï¼‰
* ğŸ”¢ `quantity` ã‚’ `count` ã«å¤‰ãˆãŸã„ï¼ˆå‘½åå¤‰æ›´ï¼‰
* ğŸ§  æ„å‘³ãŒå¤‰ã‚ã£ãŸï¼ˆä¾‹ï¼š`price` ãŒã€Œç¨è¾¼ã€â†’ã€Œç¨æŠœã€ã«ãªã£ãŸï¼‰â†ã“ã‚Œã¯å±é™ºâš ï¸

**ãƒã‚¤ãƒ³ãƒˆ**ï¼š
ã€Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¢—ã‚„ã™ã€ã¿ãŸã„ãªå¤‰æ›´ã¯ã‚ã‚Šã¨å®‰å…¨ã€‚
ã§ã‚‚ã€Œæ„å‘³ãŒå¤‰ã‚ã‚‹ã€å¤‰æ›´ã¯äº‹æ•…ã‚Šã‚„ã™ã„ã®ã§ã€**æ–°ã‚¤ãƒ™ãƒ³ãƒˆ**ã‹ **Upcast** ãŒå¿…è¦ã«ãªã‚ŠãŒã¡ã ã‚ˆğŸ§¯

---

## 3) é€²åŒ–ã®3æˆ¦ç•¥ï¼ˆã‚„ã•ã—ã„é †ï¼‰ğŸ¥šâ¡ï¸ğŸ¥â¡ï¸ğŸ¦…

![ã‚¤ãƒ™ãƒ³ãƒˆã®é€²åŒ–](./picture/es_ts_study_035_versioning.png)

```mermaid
graph TD
    Add[Add Field] --> Safe[Safe / Backward Compatible]
    NewEv[New Event] --> Intent[Change of Intent]
    Upcast[Upcasting] --> Retro[Retrospective Correction]
    
    subgraph Versioning Strategies
        Add
        NewEv
        Upcast
    end
```


## æˆ¦ç•¥Aï¼šè¶³ã™ï¼ˆå¾Œæ–¹äº’æ›ï¼‰â•âœ…

å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã€‚
ã„ã¡ã°ã‚“å¤šç”¨ã•ã‚Œã‚‹ã—ã€é‹ç”¨ã‚‚ãƒ©ã‚¯âœ¨ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã®éå»ãŒãã®ã¾ã¾æ´»ãã‚‹ï¼‰

* âœ… ä¾‹ï¼š`displayName?: string` ã‚’è¿½åŠ ï¼ˆç„¡ã‘ã‚Œã°æ—¢å®šå€¤ã§è¡¨ç¤ºï¼‰
* âœ… ä¾‹ï¼š`couponCode?: string` ã‚’è¿½åŠ ï¼ˆç„¡ã‘ã‚Œã°æœªé©ç”¨ï¼‰

**æ³¨æ„**ï¼šå‰Šé™¤ãƒ»å‹å¤‰æ›´ã¯é¿ã‘ã‚‹ğŸ™…â€â™€ï¸ï¼ˆå¾Œæ–¹äº’æ›ãŒå£Šã‚Œã‚„ã™ã„ï¼‰

---

## æˆ¦ç•¥Bï¼šæ–°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ğŸ†•ğŸ“®

ã€Œæ„å‘³ãŒå¤‰ã‚ã‚‹ã€ãªã‚‰ã€åŒã˜ã‚¤ãƒ™ãƒ³ãƒˆåã®ã¾ã¾ç¶™ãè¶³ã™ã‚ˆã‚Šã€**åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¡¨ç¾**ã™ã‚‹ã®ãŒå®‰å…¨âœ¨

* ä¾‹ï¼š`ItemPriceChanged` ã‚’å¾Œã‹ã‚‰è¿½åŠ ã™ã‚‹
* ä¾‹ï¼š`TaxRuleApplied` ã‚’è¿½åŠ ã—ã¦ã€è¨ˆç®—ãƒ«ãƒ¼ãƒ«ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã§è¡¨ç¾ã™ã‚‹

ã€Œéå»ã®äº‹å®Ÿã€ã¨ã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã€ã‚’æ··ãœãªã„ã®ãŒã‚³ãƒ„ã ã‚ˆğŸ§Šâœ¨

---

## æˆ¦ç•¥Cï¼šUpcastï¼ˆèª­ã¿å‡ºã—æ™‚ã«å¤‰æ›ï¼‰ğŸ”ğŸ§™â€â™€ï¸

å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã®å½¢ã‚’ã€æ–°ã—ã„å½¢ã«â€œèª­ã¿å‡ºã™ã¨ãã ã‘â€å¤‰æ›ã™ã‚‹æ–¹æ³•ã€‚
**ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯æ›¸ãæ›ãˆãªã„**ã®ãŒå¤§äº‹âœ¨ ([martendb.io][2])

ã“ã®è€ƒãˆæ–¹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚­ãƒ¼ãƒé€²åŒ–ã®ä»£è¡¨æ ¼ã¨ã—ã¦ã‚ˆãå‡ºã¦ãã‚‹ã‚ˆğŸ“š ([ScienceDirect][3])

---

## 4) ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã®æŒãŸã›æ–¹ï¼š2æŠï¼‹ãŠã™ã™ã‚1ã¤ğŸ›ï¸âœ¨

## æ–¹å¼1ï¼š`type` ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚ã‚‹ï¼ˆä¾‹ï¼š`CartItemAdded.v2`ï¼‰ğŸ·ï¸

* ğŸ‘ ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ã ã‘è¦‹ã‚Œã°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‹ã‚‹
* ğŸ‘ å‹åãŒå¢—ãˆã‚„ã™ã„ï¼ˆ`v1` `v2`â€¦ï¼‰

## æ–¹å¼2ï¼šãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã« `schemaVersion` ã‚’å…¥ã‚Œã‚‹ï¼ˆãŠã™ã™ã‚ï¼‰ğŸ·ï¸âœ¨

* ğŸ‘ `type` ã¯å¤‰ãˆãšã€`schemaVersion` ã§åˆ†å²ã§ãã‚‹
* ğŸ‘ Upcast ãƒã‚§ãƒ¼ãƒ³ãŒä½œã‚Šã‚„ã™ã„

ã“ã“ã§ã¯ **æ–¹å¼2** ã§è¡Œãã‚ˆğŸ˜Š

---

## 5) ã‚¤ãƒ™ãƒ³ãƒˆã®â€œå°ç­’ï¼ˆEnvelopeï¼‰â€ã‚’å›ºå®šã—ã‚ˆã†ğŸ±ğŸ“¦

ã‚¤ãƒ™ãƒ³ãƒˆæœ¬ä½“ï¼ˆdataï¼‰ã¨ã€è¿½è·¡ç”¨ã®ãƒ¡ã‚¿æƒ…å ±ï¼ˆmetaï¼‰ã‚’åˆ†ã‘ã‚‹ã¨ã€é€²åŒ–ã¨é‹ç”¨ãŒè¶…ãƒ©ã‚¯ã«ãªã‚‹ã‚ˆâœ¨

```ts
// ã‚¤ãƒ™ãƒ³ãƒˆã®â€œå°ç­’â€
export type EventEnvelope<TType extends string, TData> = {
  id: string;              // eventIdï¼ˆæ¯å›ãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  type: TType;             // ä¾‹: "CartItemAdded"
  schemaVersion: number;   // ä¾‹: 1, 2, 3...
  occurredAt: string;       // ISOæ—¥æ™‚
  data: TData;

  meta?: {
    correlationId?: string;   // ä¸€é€£ã®å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ID
    causationId?: string;     // â€œã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿã‚“ã ç›´å‰â€ã®ID
    idempotencyKey?: string;  // å†ªç­‰æ€§ã‚­ãƒ¼ï¼ˆå¾Œã§ä½¿ã†ï¼ï¼‰
  };
};
```

---

## 6) Upcast ã®æœ€å°å®Ÿè£…ï¼ˆTypeScriptï¼‰ğŸ§™â€â™€ï¸ğŸ”

## ä¾‹é¡Œï¼š`CartItemAdded` ãŒé€²åŒ–ã—ãŸğŸ“ˆ

* v1ï¼š`{ productId, quantity }`
* v2ï¼š`{ productId, quantity, displayName }`ï¼ˆè¿½åŠ ï¼‰
* v3ï¼š`{ productId, quantity, displayName, unitPrice }`ï¼ˆè¿½åŠ ï¼‰

å¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã‚€ãŸã³ã€v3 ã¾ã§â€œæŒã¡ä¸Šã’ã‚‹ï¼ˆupcastï¼‰â€ã‚ˆâœ¨

```ts
type CartItemAddedV1 = { productId: string; quantity: number };
type CartItemAddedV2 = { productId: string; quantity: number; displayName: string };
type CartItemAddedV3 = { productId: string; quantity: number; displayName: string; unitPrice: number };

type AnyCartItemAdded = CartItemAddedV1 | CartItemAddedV2 | CartItemAddedV3;

type CartItemAddedEnvelope = EventEnvelope<"CartItemAdded", AnyCartItemAdded>;

type Upcaster = (e: CartItemAddedEnvelope) => CartItemAddedEnvelope;

// v1 -> v2
const upcastCartItemAddedV1toV2: Upcaster = (e) => {
  if (e.type !== "CartItemAdded" || e.schemaVersion !== 1) return e;

  const v1 = e.data as CartItemAddedV1;
  const v2: CartItemAddedV2 = {
    productId: v1.productId,
    quantity: v1.quantity,
    displayName: "ï¼ˆåç§°æœªç™»éŒ²ï¼‰", // æ—¢å®šå€¤ã§è£œã†âœ¨
  };

  return { ...e, schemaVersion: 2, data: v2 };
};

// v2 -> v3
const upcastCartItemAddedV2toV3: Upcaster = (e) => {
  if (e.type !== "CartItemAdded" || e.schemaVersion !== 2) return e;

  const v2 = e.data as CartItemAddedV2;
  const v3: CartItemAddedV3 = {
    ...v2,
    unitPrice: 0, // æ—¢å®šå€¤ï¼ˆå¾Œã§åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆã§ä¾¡æ ¼ã‚’é©ç”¨ã™ã‚‹è¨­è¨ˆã§ã‚‚OKï¼‰
  };

  return { ...e, schemaVersion: 3, data: v3 };
};

const upcasters: Upcaster[] = [
  upcastCartItemAddedV1toV2,
  upcastCartItemAddedV2toV3,
];

export function upcastToLatest(e: CartItemAddedEnvelope): CartItemAddedEnvelope {
  // ä½•å›ã§ã‚‚é€šã—ã¦â€œæœ€æ–°â€ã¸æŒã¡ä¸Šã’ã‚‹ğŸ”
  return upcasters.reduce((acc, fn) => fn(acc), e);
}
```

**Upcast ã¯ã€Œèª­ã‚€æ™‚ã®å¤‰æ›ãƒ¬ã‚¤ãƒ¤ã€**ã¨ã„ã†è€ƒãˆæ–¹ãŒç‹é“ã ã‚ˆâœ¨ ([martendb.io][2])

---

## 7) äº’æ›æ€§ã®æœ€ä½ãƒ«ãƒ¼ãƒ«ï¼ˆã“ã‚Œã ã‘å®ˆã‚Œã°äº‹æ•…ãŒæ¸›ã‚‹ï¼‰ğŸš§âœ¨

## ã‚»ãƒ¼ãƒ•å¯„ã‚Šâœ…

* â• **ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ **ï¼ˆç„¡ã„æ™‚ã¯æ—¢å®šå€¤ or optionalï¼‰
* â• **æ–°ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ **ï¼ˆå¤ã„ã‚¤ãƒ™ãƒ³ãƒˆã¯ãã®ã¾ã¾ï¼‰

## å±é™ºâš ï¸ï¼ˆã‚„ã‚‹ãªã‚‰Upcastã‹æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼‰

* ğŸ§¨ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤
* ğŸ§¨ å‹å¤‰æ›´ï¼ˆnumberâ†’string ãªã©ï¼‰
* ğŸ§¨ æ„å‘³å¤‰æ›´ï¼ˆå˜ä½ã‚„ç¨è¨ˆç®—ãƒ«ãƒ¼ãƒ«ãŒå¤‰ã‚ã‚‹ç­‰ï¼‰

ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒé€²åŒ–ã®è€ƒãˆæ–¹ã¯ã€å¾Œæ–¹äº’æ›ã‚’å®ˆã‚‹ã®ãŒåŸºæœ¬ã ã‚ˆğŸ“š ([Confluent Documentation][4])

---

## 8) å†ªç­‰æ€§ï¼ˆIdempotencyï¼‰ã£ã¦ãªã«ï¼ŸğŸ§·ğŸ”

**åŒã˜æ“ä½œãŒ2å›å±Šã„ã¦ã‚‚ã€çµæœãŒ1å›åˆ†ã«ãªã‚‹**æ€§è³ªã ã‚ˆâœ¨
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯æ™®é€šã«å¤±æ•—ã™ã‚‹ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚‚ã‚µãƒ¼ãƒã‚‚æ™®é€šã«ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã‹ã‚‰ã€å†ªç­‰æ€§ã¯â€œã»ã¼å¿…é ˆâ€ã«ãªã‚ŠãŒã¡ğŸ˜µâ€ğŸ’«

ç‰¹ã« **POST / PATCH** ã®å†é€ã‚’å®‰å…¨ã«ã™ã‚‹ãŸã‚ã«ã€`Idempotency-Key` ã¨ã„ã†ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†æ¡ˆãŒæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã‚ˆğŸ“®âœ¨

* IETF ã®ãƒ‰ãƒ©ãƒ•ãƒˆï¼š`Idempotency-Key` ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä»•æ§˜æ¡ˆ ([IETF Datatracker][5])
* MDN Web Docs ã®è§£èª¬ã‚‚ã‚ã‚‹ã‚ˆ ([MDNã‚¦ã‚§ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][6])

ã•ã‚‰ã«ã€APIè¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã‚‚ã€Œãƒªãƒˆãƒ©ã‚¤ã§é‡è¤‡ã‚’ä½œã‚‰ãªã„ã€ï¼å†ªç­‰æ€§ãŒå¼·ãæ¨ã•ã‚Œã¦ã‚‹ã‚ˆğŸ§¯ ([Postman Blog][7])

---

## 9) ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã§å†ªç­‰æ€§ã‚’â€œæœ€å°â€ã§å…¥ã‚Œã‚‹å ´æ‰€ğŸ§©âœ¨

å†ªç­‰æ€§ã¯ã ã„ãŸã„ **å¢ƒç•Œï¼ˆå¤–ã‹ã‚‰å…¥ã£ã¦ãã‚‹ã¨ã“ã‚ï¼‰**ã§å®ˆã‚‹ã®ãŒã„ã¡ã°ã‚“åŠ¹ãã‚ˆğŸ’ª

* ğŸŒ HTTP APIï¼ˆãƒœã‚¿ãƒ³é€£æ‰“ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†é€ï¼‰
* ğŸ“¬ ã‚­ãƒ¥ãƒ¼/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå†é…é”ãŒæ™®é€šã«èµ·ãã‚‹ï¼‰

ãã—ã¦ç¾å®Ÿã§ã¯ã€ŒOutboxã€ãªã©ã§ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡ã®ä¿¡é ¼æ€§ã‚’ä¸Šã’ã‚‹ã¨ã€**æ¶ˆè²»å´ã¯å†ªç­‰**ãŒå‰æã«ãªã‚Šã‚„ã™ã„ã‚ˆğŸ” ([james-carr.org][8])

---

## 10) å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šIdempotency ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆSQLiteï¼‰ğŸ—„ï¸ğŸ§·

ã„ã¡ã°ã‚“ã‚ã‹ã‚Šã‚„ã™ã„æœ€å°è§£ã¯ã“ã‚ŒğŸ‘‡

* `idempotency_key` ã‚’ä¿å­˜ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‹
* **UNIQUE åˆ¶ç´„**ã§ã€ŒåŒã˜ã‚­ãƒ¼ã¯2å›å…¥ã‚‰ãªã„ã€ã‚’DBã«å®ˆã‚‰ã›ã‚‹
* ã™ã§ã«å­˜åœ¨ã—ãŸã‚‰ã€Œå‰å›ã®çµæœã‚’è¿”ã™ã€ã ã‘ã§OKâœ¨

## ãƒ†ãƒ¼ãƒ–ãƒ«ä¾‹ï¼ˆæœ€å°ï¼‰

```sql
-- ã™ã§ã«å‡¦ç†ã—ãŸ â€œæ“ä½œâ€ ã®è¨˜éŒ²
CREATE TABLE IF NOT EXISTS idempotency (
  key TEXT PRIMARY KEY,          -- Idempotency-Key
  stream_id TEXT NOT NULL,
  result_json TEXT NOT NULL,     -- å‰å›è¿”ã—ãŸçµæœï¼ˆæœ€å°ãªã‚‰ã‚¤ãƒ™ãƒ³ãƒˆIDç­‰ã§ã‚‚OKï¼‰
  created_at TEXT NOT NULL
);
```

---

## 11) ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ï¼ˆLoad â†’ Decide â†’ Appendï¼‰ã«å†ªç­‰æ€§ã‚’å·®ã—è¾¼ã‚€ğŸ§ ğŸ”

## â€œå‹â€ã¯ã“ã†ãªã‚‹ã‚ˆğŸ“®âœ…

1. `idempotency_key` ã‚’è¦‹ã¦ **æ—¢å‡¦ç†ãªã‚‰å³return**
2. æœªå‡¦ç†ãªã‚‰æ™®é€šã«å‡¦ç†ï¼ˆLoadâ†’Decideâ†’Appendï¼‰
3. æœ€å¾Œã« `idempotency` ã«çµæœã‚’ä¿å­˜ï¼ˆæ¬¡ã®é‡è¤‡ã«å‚™ãˆã‚‹ï¼‰

```ts
export type Command<TType extends string, TPayload> = {
  type: TType;
  payload: TPayload;
  idempotencyKey: string;   // â† å¤–ã‹ã‚‰å¿…ãšæ¸¡ã•ã‚Œã‚‹æƒ³å®š
};

export type CommandResult = {
  ok: true;
  appendedEventIds: string[];
} | {
  ok: false;
  error: string;
};

// DBã£ã½ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆä¸­èº«ã¯SQLiteæƒ³å®šï¼‰
type IdempotencyRepo = {
  find(key: string): { streamId: string; resultJson: string } | null;
  tryInsert(key: string, streamId: string, resultJson: string): "inserted" | "duplicate";
};

// ã“ã“ã¯æ—¢ã«ä½œã£ãŸ EventStoreï¼ˆSQLiteç‰ˆï¼‰ã‚’æƒ³å®š
type EventStore = {
  readStream(streamId: string): Promise<EventEnvelope<string, any>[]>;
  appendToStream(streamId: string, expectedVersion: number, events: EventEnvelope<string, any>[]): Promise<string[]>;
};

export async function handleAddItem(
  cmd: Command<"AddItem", { cartId: string; productId: string; quantity: number }>,
  deps: { idempo: IdempotencyRepo; store: EventStore }
): Promise<CommandResult> {
  const streamId = `cart-${cmd.payload.cartId}`;

  // â‘  æ—¢å‡¦ç†ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é€Ÿã§è¿”ã™ï¼ï¼‰
  const cached = deps.idempo.find(cmd.idempotencyKey);
  if (cached) {
    return JSON.parse(cached.resultJson) as CommandResult;
  }

  // â‘¡ ãµã¤ã†ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®å‹ã§å‡¦ç†
  const past = await deps.store.readStream(streamId);
  const currentVersion = past.length; // æœ€å°ã®ä¾‹ï¼ˆå®Ÿç‰©ã¯versionã‚’æŒã¤æ–¹ãŒå®‰å…¨ï¼‰

  // Decideï¼ˆã“ã“ã§ã¯ç°¡æ˜“ã«1ã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  const event: EventEnvelope<"CartItemAdded", CartItemAddedV3> = {
    id: crypto.randomUUID(),
    type: "CartItemAdded",
    schemaVersion: 3,
    occurredAt: new Date().toISOString(),
    data: {
      productId: cmd.payload.productId,
      quantity: cmd.payload.quantity,
      displayName: "ï¼ˆåç§°ã¯å¾Œã§ï¼‰",
      unitPrice: 0,
    },
    meta: { idempotencyKey: cmd.idempotencyKey },
  };

  const appendedIds = await deps.store.appendToStream(streamId, currentVersion, [event]);

  const result: CommandResult = { ok: true, appendedEventIds: appendedIds };

  // â‘¢ çµæœã‚’ä¿å­˜ï¼ˆæ¬¡å›ã€åŒã˜ã‚­ãƒ¼ãŒæ¥ãŸã‚‰åŒã˜çµæœã‚’è¿”ã™ï¼‰
  // ã“ã“ã¯æœ¬å½“ã¯ â€œAppendã¨åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³â€ ã«å…¥ã‚Œã‚‹ã®ãŒç†æƒ³âœ¨
  const save = deps.idempo.tryInsert(cmd.idempotencyKey, streamId, JSON.stringify(result));
  if (save === "duplicate") {
    // ã»ã¼åŒæ™‚ã«äºŒé‡å®Ÿè¡ŒãŒèµ°ã£ãŸã‚±ãƒ¼ã‚¹ï¼ˆãƒ¬ãƒ¼ã‚¹ï¼‰âš”ï¸
    const cached2 = deps.idempo.find(cmd.idempotencyKey);
    if (cached2) return JSON.parse(cached2.resultJson) as CommandResult;
  }

  return result;
}
```

> ğŸ’¡ å®Ÿå‹™ã§ã¯ã€Œã‚¤ãƒ™ãƒ³ãƒˆAppendã€ã¨ã€Œidempotencyä¿å­˜ã€ã‚’**åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**ã«ã™ã‚‹ã¨ã‚ˆã‚Šå®‰å…¨ã ã‚ˆï¼ˆãƒ¬ãƒ¼ã‚¹ã§äºŒé‡Appendã—ã«ãã„ï¼‰ğŸ§¯
> ã“ã†ã„ã†â€œé‡è¤‡æ’é™¤ã¯DBåˆ¶ç´„ã«å¯„ã›ã‚‹â€è€ƒãˆæ–¹ã¯ã‚ˆãä½¿ã‚ã‚Œã‚‹âœ¨ ([Stack Overflow][9])

---

## 12) ãƒ†ã‚¹ãƒˆã®å‹ï¼ˆGiven-When-Thenï¼‰ğŸ§ªğŸŒ¸

## ãƒ†ã‚¹ãƒˆAï¼šUpcast ãŒæ­£ã—ãæœ€æ–°ã«ä¸ŠãŒã‚‹ï¼Ÿ

```ts
import { test, expect } from "vitest";

test("upcast v1 -> v3", () => {
  const v1: CartItemAddedEnvelope = {
    id: "e1",
    type: "CartItemAdded",
    schemaVersion: 1,
    occurredAt: "2026-01-01T00:00:00.000Z",
    data: { productId: "p1", quantity: 2 },
  };

  const latest = upcastToLatest(v1);
  expect(latest.schemaVersion).toBe(3);

  const d = latest.data as CartItemAddedV3;
  expect(d.displayName).toBe("ï¼ˆåç§°æœªç™»éŒ²ï¼‰");
  expect(d.unitPrice).toBe(0);
});
```

## ãƒ†ã‚¹ãƒˆBï¼šåŒã˜ã‚³ãƒãƒ³ãƒ‰ã‚’2å›æŠ•ã’ã¦ã‚‚ã€ã‚¤ãƒ™ãƒ³ãƒˆã¯å¢—ãˆãªã„ï¼Ÿ

* 1å›ç›®ï¼šAppendã•ã‚Œã‚‹âœ…
* 2å›ç›®ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥çµæœãŒè¿”ã£ã¦ã€Appendã•ã‚Œãªã„ğŸ”âœ…

ï¼ˆã“ã“ã¯ `IdempotencyRepo` ã‚’ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå®Ÿè£…ã—ã¦ç¢ºèªã™ã‚‹ã¨æ¥½ã ã‚ˆğŸ˜Šï¼‰

---

## 13) ãƒŸãƒ‹æ¼”ç¿’ï¼ˆè¶…ãŠã™ã™ã‚ï¼‰âœï¸âœ¨

## æ¼”ç¿’1ï¼šã‚¤ãƒ™ãƒ³ãƒˆã«é …ç›®è¿½åŠ ã—ã¦ã‚‚å£Šã•ãªã„â•ğŸ§¬

1. `CartItemAdded` ã« `category?: string` ã‚’è¿½åŠ 
2. v3 â†’ v4 ã«ã—ã¦ã€Upcastã§ `category = "unknown"` ã‚’è£œã†
3. Upcastãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦åˆæ ¼ã•ã›ã‚‹âœ…

## æ¼”ç¿’2ï¼šå†ªç­‰æ€§ã‚­ãƒ¼ã§ã€Œãƒœã‚¿ãƒ³é€£æ‰“ã€è€æ€§ã‚’ä½œã‚‹ğŸ”ğŸ§·

1. ã‚³ãƒãƒ³ãƒ‰ã« `idempotencyKey` ã‚’å¿…é ˆã«ã™ã‚‹
2. 2å›é€£ç¶šã§åŒã˜ã‚­ãƒ¼ã‚’æŠ•ã’ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
3. â€œã‚¤ãƒ™ãƒ³ãƒˆæ•°ãŒå¢—ãˆãªã„â€ã‚’æ¤œè¨¼ã™ã‚‹âœ…âœ…

## æ¼”ç¿’3ï¼ˆãŠã¾ã‘â­ï¼‰ï¼šæ¶ˆè²»å´ã®å†ªç­‰æ€§ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé‡è¤‡é…ä¿¡ã«å‚™ãˆã‚‹ï¼‰ğŸ“¬ğŸ”

* `processed_event` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ã¦ `eventId` ã‚’ä¿å­˜
* ã™ã§ã«è¦‹ãŸ `eventId` ãªã‚‰Projectionæ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—
  ï¼ˆOutbox/å†é…é”ã§é‡è¦ã«ãªã‚‹ã‚„ã¤ï¼ï¼‰ ([james-carr.org][8])

---

## 14) AIæ´»ç”¨ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ï¼‰ğŸ¤–ğŸ’­âœ¨

## é€²åŒ–ã®ç›¸è«‡ï¼šã©ã®æˆ¦ç•¥ãŒå®‰å…¨ï¼ŸğŸ§¬

* ã€Œã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã—ãŸã„ã€‚æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å£Šã•ãšã«é€²åŒ–ã™ã‚‹æˆ¦ç•¥ã‚’ã€A:è¶³ã™ / B:æ–°ã‚¤ãƒ™ãƒ³ãƒˆ / C:Upcast ã§æ¯”è¼ƒã—ã¦ã€æ¨å¥¨ã¨ç†ç”±ã‚’å‡ºã—ã¦ã€

## Upcastãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šäº‹æ•…ã‚Šãã†ãªç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ğŸ‘€ğŸ§¯

* ã€Œã“ã®Upcasterã®å±é™ºãƒã‚¤ãƒ³ãƒˆï¼ˆæ„å‘³å¤‰æ›´ã€æ—¢å®šå€¤ã®å¦¥å½“æ€§ã€æ¬ æãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã§ã€

## å†ªç­‰æ€§ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šã‚­ãƒ¼è¨­è¨ˆã‚’ç¢ºèªğŸ”‘âœ¨

* ã€ŒIdempotency-Key ã‚’ã©ã†ç”Ÿæˆã™ã¹ãã‹ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆéƒ½åˆï¼ˆãƒœã‚¿ãƒ³é€£æ‰“ãƒ»å†é€ï¼‰ã¨ã‚µãƒ¼ãƒéƒ½åˆï¼ˆä¿å­˜æœŸé–“ãƒ»è¡çªãƒ»çµæœå†åˆ©ç”¨ï¼‰ã§æ•´ç†ã—ã¦ã€

---

## 15) ã¾ã¨ã‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ§¾âœ¨

## ã‚¤ãƒ™ãƒ³ãƒˆé€²åŒ–ğŸ§¬

* [ ] éå»ã‚¤ãƒ™ãƒ³ãƒˆã¯æ›¸ãæ›ãˆãªã„ğŸ§Š
* [ ] ã¾ãšã¯ã€Œè¶³ã™ã€ã§æ¸ˆã‚€ã‹è€ƒãˆã‚‹â•
* [ ] æ„å‘³ãŒå¤‰ã‚ã‚‹ãªã‚‰æ–°ã‚¤ãƒ™ãƒ³ãƒˆ or UpcastğŸ†•ğŸ”
* [ ] Upcastã®ãƒ†ã‚¹ãƒˆï¼ˆv1â†’æœ€æ–°ï¼‰ã‚’å¿…ãšç”¨æ„ğŸ§ª

## å†ªç­‰æ€§ğŸ§·

* [ ] ãƒªãƒˆãƒ©ã‚¤ã¯èµ·ãã‚‹å‰æï¼ˆHTTP/ã‚­ãƒ¥ãƒ¼ï¼‰ğŸ”
* [ ] `Idempotency-Key` ã‚’å¢ƒç•Œã§å—ã‘å–ã‚‹ğŸ“® ([IETF Datatracker][5])
* [ ] UNIQUEåˆ¶ç´„ã§é‡è¤‡æ’é™¤ã‚’DBã«ä»»ã›ã‚‹ğŸ—„ï¸
* [ ] â€œåŒã˜ã‚­ãƒ¼ãªã‚‰åŒã˜çµæœã‚’è¿”ã™â€ã‚’å®ˆã‚‹âœ… ([Postman Blog][7])

---

[1]: https://event-driven.io/en/simple_events_versioning_patterns/?utm_source=chatgpt.com "Simple patterns for events schema versioning"
[2]: https://martendb.io/events/versioning.html?utm_source=chatgpt.com "Events Versioning"
[3]: https://www.sciencedirect.com/science/article/pii/S0164121221000674?utm_source=chatgpt.com "An empirical characterization of event sourced systems ..."
[4]: https://docs.confluent.io/platform/current/schema-registry/fundamentals/schema-evolution.html?utm_source=chatgpt.com "Schema Evolution and Compatibility for Schema Registry ..."
[5]: https://datatracker.ietf.org/doc/draft-ietf-httpapi-idempotency-key-header/?utm_source=chatgpt.com "The Idempotency-Key HTTP Header Field - Datatracker - IETF"
[6]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Idempotency-Key?utm_source=chatgpt.com "Idempotency-Key header - HTTP - MDN Web Docs"
[7]: https://blog.postman.com/rest-api-best-practices/?utm_source=chatgpt.com "REST API Best Practices: A Developer's Guide to Building ..."
[8]: https://james-carr.org/posts/2026-01-15-transactional-outbox-pattern/?utm_source=chatgpt.com "The Transactional Outbox Pattern: Reliable Event Publishing"
[9]: https://stackoverflow.com/questions/70822463/idempotent-record-creation-is-it-better-to-use-a-unique-constraint-or-check-for?utm_source=chatgpt.com "Idempotent record creation: is it better to use a unique ..."
