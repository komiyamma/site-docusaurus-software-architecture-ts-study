# 18ç« ï¼šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å®Ÿè£…â‘ ï¼ˆä½œæˆç³»ï¼‰ğŸ†•âœ¨

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ ğŸ¯ğŸ˜Š

* ã€Œä½œæˆã™ã‚‹ã€ã‚³ãƒãƒ³ãƒ‰ï¼ˆCreateï¼‰ã‚’ã€ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆCreatedï¼‰ã¨ã—ã¦ç©ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹âœ¨
* ã‚¤ãƒ™ãƒ³ãƒˆåˆ—ã‹ã‚‰ã€ã¡ã‚ƒã‚“ã¨çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆRehydrateï¼‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ”
* ã€Œä½œæˆç³»ã¯ç‰¹åˆ¥ã€ãªç†ç”±ï¼ˆæœ€åˆã®1ç™ºãŒä¸–ç•Œã‚’ä½œã‚‹ğŸŒï¼‰ã‚’ä½“æ„Ÿã§ãã‚‹ğŸ’¡

---

## 18.1 ä½œæˆç³»ãŒâ€œã¡ã‚‡ã£ã¨ç‰¹åˆ¥â€ãªç†ç”± ğŸ§ âœ¨

æ›´æ–°ç³»ã¯ã€Œã™ã§ã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã€ã‚’å¤‰ãˆã‚‹ã‘ã©ã€ä½œæˆç³»ã¯ **ã€Œå­˜åœ¨ã—ãªã„ã¨ã“ã‚ã‹ã‚‰ã€å­˜åœ¨ã‚’ç”Ÿã‚€ã€** ã‚“ã ã‚ˆã­ğŸ‘¶âœ¨

ã ã‹ã‚‰ä½œæˆç³»ã§ã¯â€¦

* ã¾ã ã‚¤ãƒ™ãƒ³ãƒˆãŒ1ä»¶ã‚‚ç„¡ã„ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒç©ºã£ã½ï¼‰ğŸ“­
* ãªã®ã«ã€ŒäºŒé‡ä½œæˆã¯ãƒ€ãƒ¡ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã¯å®ˆã‚ŠãŸã„ğŸ›¡ï¸
* ãã—ã¦ **Createdã‚¤ãƒ™ãƒ³ãƒˆãŒ1ä»¶ç›®ã¨ã—ã¦å…¥ã‚‹** ã¨ã€ä¸–ç•ŒãŒå§‹ã¾ã‚‹ğŸŒ±âœ¨

---

## 18.2 ä»Šæ—¥ã®é¡Œæï¼šã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã‚’ä½œã‚‹ğŸ›’ğŸ˜Š

### ã‚³ãƒãƒ³ãƒ‰ï¼ˆã‚„ã‚ŠãŸã„ã“ã¨ï¼‰ğŸ“®

* **CreateCart**ï¼šã‚«ãƒ¼ãƒˆã‚’æ–°è¦ä½œæˆã—ãŸã„ï¼

### ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆèµ·ããŸäº‹å®Ÿï¼‰ğŸ“œ

* **CartCreated**ï¼šã‚«ãƒ¼ãƒˆãŒä½œæˆã•ã‚ŒãŸï¼

> ã“ã“ã§ã¯ã€Œã‚«ãƒ¼ãƒˆä½œæˆã€ã ã‘ã«é›†ä¸­ã™ã‚‹ã‚ˆğŸ§˜â€â™€ï¸âœ¨
> æ¬¡ã®ç« ã§ã€Œæ›´æ–°ï¼ˆã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ã¨ã‹ï¼‰ã€ã‚’ã‚„ã‚‹ã‚ˆã€œğŸ”§

---

## 18.3 è¨­è¨ˆãƒŸãƒ‹ï¼šã‚¤ãƒ™ãƒ³ãƒˆåã¨Payloadã®æ±ºã‚æ–¹ğŸ±âœ¨

### âœ… ã‚¤ãƒ™ãƒ³ãƒˆåã¯éå»å½¢

* CartCreatedï¼ˆä½œæˆã•ã‚ŒãŸï¼‰âœ…
* CartCreateï¼ˆå‘½ä»¤ã£ã½ã„ï¼‰âŒ
* CreateCartï¼ˆã‚³ãƒãƒ³ãƒ‰ã£ã½ã„ï¼‰âŒ

### âœ… Payloadã¯ã€Œäº‹å®Ÿã€ã ã‘

CartCreatedã«å…¥ã‚Œã‚‹ã®ã¯ä¾‹ãˆã°ã“ã‚“ãªæ„Ÿã˜ğŸ‘‡

* cartIdï¼ˆã©ã®ã‚«ãƒ¼ãƒˆï¼Ÿï¼‰
* customerIdï¼ˆèª°ã®ã‚«ãƒ¼ãƒˆï¼Ÿï¼‰

ã€Œç”»é¢ã«è¡¨ç¤ºã—ãŸã„ã‹ã‚‰â€¦ã€ã§ã€ä½™è¨ˆãªè¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œãªã„ã®ãŒã‚³ãƒ„ã ã‚ˆğŸ±ğŸš«
ï¼ˆè¡¨ç¤ºç”¨ã¯Projectionå´ã§ä½œã‚‹ğŸ”âœ¨ï¼‰

---

## 18.4 å®Ÿè£…ï¼šãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆã“ã®ç« ã§è§¦ã‚‹ã¨ã“ã‚ï¼‰ğŸ§©ğŸ“

* *src/domain/cart.ts*ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šã‚³ãƒãƒ³ãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»çŠ¶æ…‹ãƒ»åˆ¤æ–­ï¼‰
* *src/infra/inMemoryEventStore.ts*ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªEventStoreï¼‰
* *src/app/createCart.ts*ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼šLoadâ†’Decideâ†’Appendï¼‰
* *src/demo.ts*ï¼ˆå‹•ä½œç¢ºèªï¼‰

---

## 18.5* **Append**ï¼šEventStoreã«ãã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç©ã‚“ã§çµ‚ã‚ã‚Šï¼ğŸ“¦âœ¨

![æ–°è¦ä½œæˆãƒ•ãƒ­ãƒ¼ï¼šLoad(None) -> Decide -> Append](./picture/es_ts_study_018_create_flow.png)

ã€Œã¾ã ä½•ã‚‚èµ·ãã¦ãªã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã€ã«æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç½®ãã‚¤ãƒ¡ãƒ¼ã‚¸ã ã‚ˆğŸ˜ŠğŸŒ¸

```mermaid
flowchart LR
    Start([Start]) -- Load --> Empty[Empty History]
    Empty -- Rehydrate --> Init[Initial State]
    Init -- Decide --> Created[CartCreated Event]
    Created -- Append --> Store[(Event Store)]
```

---

## 18.5 å®Ÿè£…ï¼šEventStoreï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰ğŸ“¦âœ…

```ts
// src/infra/inMemoryEventStore.ts
import { randomUUID } from "node:crypto";

export type EventEnvelope<TType extends string, TData> = {
  id: string;                 // eventId
  type: TType;                // "CartCreated" ãªã©
  data: TData;                // payloadï¼ˆäº‹å®Ÿï¼‰
  meta: {
    occurredAt: string;       // ISOæ–‡å­—åˆ—
  };
};

export type StoredEvent = {
  streamId: string;
  version: number;            // 0,1,2,...ï¼ˆé †ç•ªãŒå‘½ï¼ï¼‰
  event: EventEnvelope<string, unknown>;
};

export class ConcurrencyError extends Error {
  constructor(
    public readonly streamId: string,
    public readonly expectedVersion: number,
    public readonly actualVersion: number
  ) {
    super(
      `ConcurrencyError: streamId=${streamId} expected=${expectedVersion} actual=${actualVersion}`
    );
  }
}

export class InMemoryEventStore {
  private streams = new Map<string, StoredEvent[]>();

  readStream(streamId: string): StoredEvent[] {
    return this.streams.get(streamId) ?? [];
  }

  appendToStream(
    streamId: string,
    expectedVersion: number,
    newEvents: Array<{ type: string; data: unknown }>
  ): number {
    const current = this.streams.get(streamId) ?? [];
    const actualVersion = current.length - 1; // ç©ºãªã‚‰ -1

    if (expectedVersion !== actualVersion) {
      throw new ConcurrencyError(streamId, expectedVersion, actualVersion);
    }

    const appended: StoredEvent[] = newEvents.map((e, idx) => {
      const version = current.length + idx;
      return {
        streamId,
        version,
        event: {
          id: randomUUID(),
          type: e.type,
          data: e.data,
          meta: { occurredAt: new Date().toISOString() },
        },
      };
    });

    const next = current.concat(appended);
    this.streams.set(streamId, next);

    return next.length - 1; // æœ€çµ‚version
  }
}
```

---

## 18.6 å®Ÿè£…ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆCommand / Event / State / Decide / Applyï¼‰ğŸ§ ğŸ“®ğŸ“œ

```ts
// src/domain/cart.ts
import type { EventEnvelope, StoredEvent } from "../infra/inMemoryEventStore";

// --------------------
// ã‚³ãƒãƒ³ãƒ‰
// --------------------
export type CreateCartCommand = {
  type: "CreateCart";
  cartId: string;
  customerId: string;
};

export type CartCommand = CreateCartCommand;

// --------------------
// ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã“ã®ç« ã¯ä½œæˆç³»ã ã‘ï¼‰
// --------------------
export type CartCreated = EventEnvelope<
  "CartCreated",
  { cartId: string; customerId: string }
>;

export type CartEvent = CartCreated;

// --------------------
// çŠ¶æ…‹
// --------------------
export type CartState =
  | { status: "Empty" } // ã¾ã å­˜åœ¨ã—ãªã„çŠ¶æ…‹
  | { status: "Active"; cartId: string; customerId: string };

export const emptyCartState = (): CartState => ({ status: "Empty" });

// --------------------
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆä¾‹å¤–ã˜ã‚ƒãªãã€å‹ã§è¿”ã™æ–¹ï¼‰ğŸ§¯
// --------------------
export type DomainError =
  | { type: "CartAlreadyExists"; cartId: string }
  | { type: "InvalidId"; field: "cartId" | "customerId" };

export type Result<T> =
  | { ok: true; value: T }
  | { ok: false; error: DomainError };

const isBlank = (s: string) => s.trim().length === 0;

// --------------------
// Decideï¼šçŠ¶æ…‹ + ã‚³ãƒãƒ³ãƒ‰ â†’ æ–°ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰
// --------------------
export function decide(state: CartState, command: CartCommand): Result<CartEvent[]> {
  switch (command.type) {
    case "CreateCart": {
      if (isBlank(command.cartId)) {
        return { ok: false, error: { type: "InvalidId", field: "cartId" } };
      }
      if (isBlank(command.customerId)) {
        return { ok: false, error: { type: "InvalidId", field: "customerId" } };
      }

      // ã™ã§ã«ä½œæˆæ¸ˆã¿ãªã‚‰äºŒé‡ä½œæˆNGğŸ™…â€â™€ï¸
      if (state.status !== "Empty") {
        return { ok: false, error: { type: "CartAlreadyExists", cartId: command.cartId } };
      }

      // ã€Œèµ·ããŸäº‹å®Ÿã€ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¿”ã™ğŸ“œâœ¨
      const created: CartCreated = {
        id: "placeholder", // ã“ã“ã¯EventStoreãŒæ¡ç•ªã™ã‚‹ï¼ˆappendæ™‚ã«ä¸Šæ›¸ãã™ã‚‹é‹ç”¨ã§ã‚‚OKï¼‰
        type: "CartCreated",
        data: {
          cartId: command.cartId,
          customerId: command.customerId,
        },
        meta: { occurredAt: "placeholder" },
      };

      return { ok: true, value: [created] };
    }
  }
}

// --------------------
// Applyï¼šã‚¤ãƒ™ãƒ³ãƒˆ1ä»¶ã§çŠ¶æ…‹ã‚’é€²ã‚ã‚‹ğŸ”
// --------------------
export function apply(state: CartState, event: CartEvent): CartState {
  switch (event.type) {
    case "CartCreated":
      return {
        status: "Active",
        cartId: event.data.cartId,
        customerId: event.data.customerId,
      };
  }
}

// --------------------
// Rehydrateï¼šã‚¤ãƒ™ãƒ³ãƒˆåˆ—ã‹ã‚‰çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹ğŸ”ğŸ§ 
// --------------------
export function rehydrate(history: StoredEvent[]): CartState {
  let state: CartState = emptyCartState();

  for (const item of history) {
    // å‹å®‰å…¨ã®ãŸã‚ã€ã“ã“ã§ã¯CartEventã ã‘æµã‚Œã¦ãã‚‹å‰æã«ã—ã¦ã‚‹ã‚ˆğŸ˜Š
    state = apply(state, item.event as CartEvent);
  }
  return state;
}

// --------------------
// ã‚¹ãƒˆãƒªãƒ¼ãƒ IDï¼ˆã“ã®ç« ã¯1é›†ç´„=1ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼‰ğŸ“¼
// --------------------
export const cartStreamId = (cartId: string) => `cart-${cartId}`;
```

### ã¡ã‚‡ã„ãƒ¡ãƒ¢ï¼ˆå‹ã®è©±ï¼‰ğŸ“âœ¨

* ã€ŒDecideã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿”ã™ã€â†’ ã“ã“ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®å¿ƒè‡“éƒ¨ğŸ’“
* ã€ŒApplyã¯çŠ¶æ…‹ã‚’ä½œã‚‹ã€â†’ å¾©å…ƒã‚‚Projectionã‚‚ã€ã ã„ãŸã„ã“ã®è€ƒãˆæ–¹ã§ã„ã‘ã‚‹ğŸ”

---

## 18.7 å®Ÿè£…ï¼šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆLoad â†’ Decide â†’ Appendï¼‰ğŸ“®âœ…

```ts
// src/app/createCart.ts
import { InMemoryEventStore } from "../infra/inMemoryEventStore";
import { cartStreamId, decide, rehydrate, type CreateCartCommand, type Result } from "../domain/cart";

export type UseCaseError =
  | { type: "Concurrency"; message: string } // ã“ã®ç« ã¯è»½ãè§¦ã‚‹ã ã‘
  | { type: "Unknown"; message: string };

export type UseCaseResult =
  | { ok: true }
  | { ok: false; error: UseCaseError | ReturnType<typeof decide> extends Result<any> ? never : never };

export function handleCreateCart(
  store: InMemoryEventStore,
  command: CreateCartCommand
): Result<void> | { ok: false; error: UseCaseError } {
  const streamId = cartStreamId(command.cartId);

  // 1) Loadï¼ˆéå»ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã‚€ï¼‰
  const history = store.readStream(streamId);

  // 2) Rehydrateï¼ˆçŠ¶æ…‹ã‚’å¾©å…ƒï¼‰
  const state = rehydrate(history);

  // 3) Decideï¼ˆä¸å¤‰æ¡ä»¶ãƒã‚§ãƒƒã‚¯â†’æ–°ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼‰
  const decided = decide(state, command);
  if (!decided.ok) return decided;

  // 4) Appendï¼ˆä¿å­˜ï¼‰â€»ä½œæˆç³»ã¯ã€Œç©ºã‚¹ãƒˆãƒªãƒ¼ãƒ ã€ã‚’æœŸå¾…ã™ã‚‹ã®ã§ expectedVersion=-1
  try {
    store.appendToStream(
      streamId,
      -1,
      decided.value.map(e => ({ type: e.type, data: e.data }))
    );
    return { ok: true, value: undefined };
  } catch (e) {
    if (e instanceof Error && e.name === "ConcurrencyError") {
      return { ok: false, error: { type: "Concurrency", message: e.message } };
    }
    return { ok: false, error: { type: "Unknown", message: String(e) } };
  }
}
```

> ã“ã“ã§ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ã€ã¾ã•ã«ã€ŒLoad â†’ Decide â†’ Appendã€ã ã‚ˆğŸ“®âœ…
> ã“ã®â€œå‹â€ãŒã‚ã‚‹ã¨ã€å®Ÿè£…ãŒãƒ–ãƒ¬ãªããªã‚‹ã®ãŒæœ€é«˜ğŸ‘âœ¨

---

## 18.8 å‹•ä½œç¢ºèªï¼ˆCreatedã‚¤ãƒ™ãƒ³ãƒˆ â†’ å¾©å…ƒã¾ã§ï¼‰ğŸ¬ğŸ”

```ts
// src/demo.ts
import { InMemoryEventStore } from "./infra/inMemoryEventStore";
import { handleCreateCart } from "./app/createCart";
import { cartStreamId, rehydrate } from "./domain/cart";

const store = new InMemoryEventStore();

const cartId = "c-001";
const customerId = "u-123";

// 1å›ç›®ï¼šæˆåŠŸâœ…
const r1 = handleCreateCart(store, { type: "CreateCart", cartId, customerId });
console.log("create #1:", r1);

// ã‚¤ãƒ™ãƒ³ãƒˆç¢ºèªğŸ“œ
const stream = store.readStream(cartStreamId(cartId));
console.log("events:", stream.map(x => ({ v: x.version, t: x.event.type, data: x.event.data })));

// çŠ¶æ…‹å¾©å…ƒğŸ”
const state = rehydrate(stream);
console.log("rehydrated state:", state);

// 2å›ç›®ï¼šäºŒé‡ä½œæˆã§å¤±æ•—ğŸ™…â€â™€ï¸
const r2 = handleCreateCart(store, { type: "CreateCart", cartId, customerId });
console.log("create #2:", r2);
```

### æœŸå¾…ã™ã‚‹å‡ºåŠ›ã®é›°å›²æ°— ğŸ‘€âœ¨

* 1å›ç›®ã¯ ok: true
* events ã« CartCreated ãŒ 1ä»¶å…¥ã‚‹
* rehydrated state ãŒ Active ã«ãªã‚‹
* 2å›ç›®ã¯ CartAlreadyExists ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ğŸ™…â€â™€ï¸

---

## 18.9 ãƒŸãƒ‹æ¼”ç¿’ï¼ˆæ‰‹ã‚’å‹•ã‹ã™ã¨ä¸€æ°—ã«ç†è§£ãŒé€²ã‚€ã‚ˆğŸ’ªğŸ˜Šï¼‰

### æ¼”ç¿’Aï¼šIDãŒç©ºæ–‡å­—ã®ã¨ãã®ã‚¨ãƒ©ãƒ¼æ–‡è¨€ã‚’æ”¹å–„ğŸ“âœ¨

ä»Šã¯ InvalidId ã ã‘ã©ã€

* ã€ŒcartIdã¯å¿…é ˆã ã‚ˆã€
* ã€ŒcustomerIdãŒç©ºã£ã½ï¼ã€
  ã¿ãŸã„ã«ã€è¡¨ç¤ºã—ã‚„ã™ã„å½¢ã«ã—ã¦ã¿ã‚ˆã†ğŸ˜Š

### æ¼”ç¿’Bï¼šCreatedã‚¤ãƒ™ãƒ³ãƒˆã« â€œä½œæˆç†ç”±â€ ã‚’å…¥ã‚ŒãŸããªã£ãŸã‚‰ï¼ŸğŸ¤”

ã€Œã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã§ä½œã£ãŸã€ã¨ã‹å…¥ã‚ŒãŸã„æ°—æŒã¡ãŒå‡ºã‚‹ã‘ã©â€¦
ãã‚Œã£ã¦ **äº‹å®Ÿï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰** ï¼Ÿãã‚Œã¨ã‚‚ **UIäº‹æƒ…** ï¼ŸğŸ±

* ã‚‚ã—äº‹å®Ÿãªã‚‰ payload ã«å…¥ã‚Œã¦OKâœ…
* UIäº‹æƒ…ãªã‚‰ Projection å´ã§ä½œã‚‹ğŸ”âœ¨

### æ¼”ç¿’Cï¼šCreatedã®ã‚ã¨ã«ã€Œä½œæˆã—ãŸæ™‚åˆ»ã€ã‚’çŠ¶æ…‹ã«ä¹—ã›ã‚‹â°

* Applyã§ state.createdAt ã‚’æŒã¤
* ã§ã‚‚ createdAt ã¯ â€œã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ¡ã‚¿â€ ã§ã‚‚ã‚ã‚‹ã‚ˆã­ï¼Ÿ
  ã©ã£ã¡ã«ç½®ãã®ãŒèª­ã¿ã‚„ã™ã„ã‹è€ƒãˆã¦ã¿ã‚ˆã†ğŸ˜Š

---

## 18.10 AIæ´»ç”¨ï¼ˆCopilot / Codexï¼‰ã§çˆ†é€Ÿã«ã™ã‚‹ğŸ¤–âš¡

### â‘  Decideã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã—ã¦ã‚‚ã‚‰ã†ğŸ”

* ã€ŒäºŒé‡ä½œæˆã‚’é˜²ã’ã¦ã‚‹ï¼Ÿã€
* ã€Œç©ºIDã‚’å¼¾ã‘ã¦ã‚‹ï¼Ÿã€
* ã€Œã‚¤ãƒ™ãƒ³ãƒˆåã¯éå»å½¢ã«ãªã£ã¦ã‚‹ï¼Ÿã€

### â‘¡ â€œã‚¤ãƒ™ãƒ³ãƒˆã®ç²’åº¦â€ ã®ç›¸è«‡ã‚’ã™ã‚‹âš–ï¸

* ã€ŒCartCreatedã ã‘ã§ååˆ†ï¼Ÿã€
* ã€ŒCustomerLinkedToCartã¿ãŸã„ã«åˆ†ã‘ã‚‹ã¹ãï¼Ÿã€

### â‘¢ Applyæ¼ã‚Œãƒã‚§ãƒƒã‚¯ã‚’ã•ã›ã‚‹ğŸ‘€

* ã€Œã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ã—ãŸã‚‰Applyã‚‚å¿…ãšæ›´æ–°ã—ã¦ã­ã€ã£ã¦ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ã‚’å›ºå®šã™ã‚‹ã¨å¼·ã„âœ…

---

## 18.11 ã‚ˆãã‚ã‚‹ãƒŸã‚¹é›†ï¼ˆã“ã“è¸ã‚€äººå¤šã„ã‚ˆã€œğŸ§¨ğŸ˜µâ€ğŸ’«ï¼‰

### âŒ ãƒŸã‚¹1ï¼šCreateã‚³ãƒãƒ³ãƒ‰ãªã®ã«ã‚¤ãƒ™ãƒ³ãƒˆåãŒç¾åœ¨å½¢

* CreateCartï¼ˆã‚³ãƒãƒ³ãƒ‰ï¼‰ã¨
* CartCreatedï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰
  ã‚’æ··ãœãªã„ã§ã­ğŸ“®ğŸ“œ

### âŒ ãƒŸã‚¹2ï¼šã‚¤ãƒ™ãƒ³ãƒˆã«è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è©°ã‚ã™ãğŸ±ğŸ’¥

ã€Œç”»é¢ã«å¿…è¦ã ã‹ã‚‰ã€ã§å…¥ã‚ŒãŸããªã‚‹ã‘ã©ã€ã‚ã¨ã§åœ°ç„ã«ãªã‚ŠãŒã¡ğŸ˜‡
è¡¨ç¤ºã¯Projectionã§ä½œã‚‹ğŸ”âœ¨

### âŒ ãƒŸã‚¹3ï¼šä½œæˆç³»ãªã®ã« expectedVersion ã‚’è¦‹ã¦ãªã„

ä½œæˆç³»ã¯ã€Œç©ºã£ã½ã®ã¯ãšã€ã‚’ä¸»å¼µã™ã‚‹ã®ãŒå¤§äº‹ğŸ“¼âœ…
ã ã‹ã‚‰ expectedVersion=-1 ã¿ãŸã„ãªãƒã‚§ãƒƒã‚¯ãŒåŠ¹ã„ã¦ãã‚‹ã‚ˆğŸ”’

---

## 18.12 ç†è§£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚µã‚¯ãƒƒã¨3å•ï¼‰âœ…ğŸ˜Š

1. CreateCartï¼ˆã‚³ãƒãƒ³ãƒ‰ï¼‰ã¨ CartCreatedï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰ã®é•ã„ã‚’ä¸€è¨€ã§è¨€ã†ã¨ï¼ŸğŸ“®ğŸ“œ
2. ä½œæˆç³»ã§äºŒé‡ä½œæˆã‚’é˜²ãæ–¹æ³•ã‚’2ã¤æŒ™ã’ã¦ã¿ã¦ğŸ›¡ï¸
3. ã€Œã‚¤ãƒ™ãƒ³ãƒˆã«å…¥ã‚Œã‚‹æƒ…å ±ã€ã¨ã€ŒProjectionã§ä½œã‚‹æƒ…å ±ã€ã®é•ã„ã¯ï¼ŸğŸ±ğŸ”

---

## ğŸ“Œæœ€æ–°ãƒ¡ãƒ¢ï¼ˆ2026/02/01æ™‚ç‚¹ï¼‰ğŸ†™ğŸ—ï¸

* TypeScriptã®å®‰å®šç‰ˆã¯ 5.9.3 ãŒ â€œLatestâ€ ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆï¼ˆGitHub Releasesï¼‰([GitHub][1])
* Node.js ã¯ v24 ãŒ Active LTSã€v25 ãŒ Current ã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã‚‹ã‚ˆï¼ˆå…¬å¼ã®ãƒªãƒªãƒ¼ã‚¹ä¸€è¦§ï¼‰([Node.js][2])
* VS Code ã®æ›´æ–°æƒ…å ±ã¯ 2026å¹´1æœˆã® 1.109ï¼ˆInsidersï¼‰ã«è¿½è¨˜ã•ã‚Œç¶šã‘ã¦ã‚‹ã‚ˆğŸ“([Visual Studio Code][3])
* Vitest ã¯å…¬å¼ã‚¬ã‚¤ãƒ‰ã§ package.json ã¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¨å¥¨ã—ã¦ã‚‹ã‚ˆğŸ§ª([Vitest][4])
* TypeScriptã® satisfies æ¼”ç®—å­ã¯ã€Œå‹ã‚’æº€ãŸã™ã‹æ¤œè¨¼ã—ã¤ã¤ã€å‹ã‚’å¤‰ãˆãªã„ã€ãŸã‚ã®ä»•çµ„ã¿ã ã‚ˆâœ…([typescriptlang.org][5])

[1]: https://github.com/microsoft/typescript/releases "Releases Â· microsoft/TypeScript Â· GitHub"
[2]: https://nodejs.org/en/about/previous-releases?utm_source=chatgpt.com "Node.js Releases"
[3]: https://code.visualstudio.com/updates/v1_109?utm_source=chatgpt.com "January 2026 Insiders (version 1.109)"
[4]: https://vitest.dev/guide/?utm_source=chatgpt.com "Getting Started | Guide"
[5]: https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-9.html?utm_source=chatgpt.com "Documentation - TypeScript 4.9"
